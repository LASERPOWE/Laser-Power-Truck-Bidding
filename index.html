<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laser Power Truck Bidding</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/truck.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        :root {
            --primary-color: #5E72E4; --secondary-color: #f4f5f7; --success-color: #2DCE89;
            --info-color: #11CDEF; --warning-color: #FB6340; --danger-color: #F5365C;
            --sidebar-bg: #172B4D; --sidebar-text: #8898AA; --sidebar-hover-bg: #1f3866;
            --sidebar-active-text: #ffffff; --content-bg: #f8f9fe; --card-bg: #ffffff;
            --text-dark: #32325d; --text-muted: #8898aa; --border-color: #dee2e6;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 10002; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10003; }
        .toast-notification { padding: 1rem 1.5rem; color: white; border-radius: 0.5rem; margin-bottom: 10px; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; }
        .toast-notification.success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .toast-notification.error { background: linear-gradient(87deg, #f5365c 0, #f56036 100%) !important; }
        .toast-notification.info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #172B4D; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        #login-container .form-control { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; }
        #login-container .form-control::placeholder { color: rgba(255,255,255,0.7); }
        .password-container { position: relative; }
        .password-container .toggle-password { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: rgba(255,255,255,0.7); }

        .wrapper { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; z-index: 1001; transition: all 0.3s ease-in-out; flex-shrink: 0; }
        .sidebar .logo { font-size: 1.2rem; font-weight: 600; text-align: center; color: white; padding: 20px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .sidebar .logo i { color: var(--info-color); }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 25px; border-radius: .375rem; margin: 0 1rem 5px; transition: all 0.2s ease; white-space: nowrap; cursor: pointer; display: flex; align-items: center; justify-content: space-between;}
        .sidebar .nav-link:hover { background-color: var(--sidebar-hover-bg); color: var(--sidebar-active-text); }
        .sidebar .nav-link.active { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; color: var(--sidebar-active-text); font-weight: 500; box-shadow: 0 4px 6px rgba(50,50,93,.11), 0 1px 3px rgba(0,0,0,.08); }
        .sidebar .nav-link .nav-link-text { display: flex; align-items: center; }
        .sidebar .nav-link .nav-link-text i { margin-right: 15px; width: 20px; text-align: center; font-size: 1rem; }
        
        .main-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 0.75rem 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 1000; flex-shrink: 0; }
        .main-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        #sidebar-toggle { font-size: 1.5rem; cursor: pointer; color: var(--text-dark); }
        #header-title { font-size: 1.25rem; font-weight: 600; color: var(--text-dark); margin: 0; }
        .user-dropdown .dropdown-toggle::after { display: none; }
        .user-dropdown .dropdown-menu { border-radius: .5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); border: 1px solid var(--border-color); }
        
        .wrapper.sidebar-collapsed .sidebar { width: 80px; }
        .wrapper.sidebar-collapsed .sidebar .logo span, .wrapper.sidebar-collapsed .sidebar .nav-link-text span, .wrapper.sidebar-collapsed .sidebar .nav-link .badge { display: none; }
        .wrapper.sidebar-collapsed .sidebar .nav-link { justify-content: center; }
        .wrapper.sidebar-collapsed .sidebar .nav-link-text i { margin-right: 0; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; top: 0; height: 100vh; }
            .wrapper.sidebar-mobile-open .sidebar { left: 0; }
            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
            .wrapper.sidebar-mobile-open .sidebar-overlay { display: block; }
        }

        .card { border: none; border-radius: .75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.2s ease-in-out; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-header { background-color: #fff; border-bottom: 1px solid #e9ecef; padding: 1rem 1.5rem; }
        .stat-card { border-radius: .75rem; color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s ease; cursor: pointer; }
        .stat-card:hover { transform: scale(1.03); }
        .stat-card h5 { font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; }
        .stat-card .display-4 { font-weight: 700; }
        .stat-card .stat-icon { font-size: 3rem; opacity: 0.3; }
        .bg-gradient-primary { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; }
        .bg-gradient-success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .bg-gradient-info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        .bg-gradient-warning { background: linear-gradient(87deg, #fb6340 0, #fbb140 100%) !important; }

        .table th, .table td { text-align: center; vertical-align: middle; }
        .table th { white-space: nowrap; }
        .table-responsive { word-break: normal; }

        @media (max-width: 768px) {
            .table { font-size: 0.85rem; }
            .table th, .table td { padding: 0.5rem 0.4rem; }
            .card-header h5, #header-title { font-size: 1.1rem; }
            .filters-card .col-md-3, .filters-card .col-md-4 { flex: 0 0 50%; max-width: 50%; }
            .main-content { padding: 1rem 0.75rem; }
            .top-header { padding: 0.75rem 1rem; }
        }

        #chat-messages { background-color: #f0f2f5; padding: 15px; display: flex; flex-direction: column; }
        .message-wrapper { display: flex; margin-bottom: 10px; max-width: 75%; }
        .message-bubble { padding: 8px 12px; border-radius: 12px; position: relative; word-break: break-word; }
        .message-wrapper.received { align-self: flex-start; }
        .message-bubble.received-bubble { background-color: #ffffff; border-top-left-radius: 0; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message-wrapper.sent { align-self: flex-end; }
        .message-bubble.sent-bubble { background-color: #dcf8c6; border-top-right-radius: 0; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message-meta { font-size: 0.75rem; color: #8898aa; text-align: right; margin-top: 4px; }
        .message-ticks { display: inline-block; margin-left: 5px; color: #8898aa; }
        .message-ticks.read { color: #34b7f1; }
        #message-form .form-control { border-radius: 20px; }
        #message-form .btn { border-radius: 50%; width: 45px; height: 45px; }
    </style>
</head>
<body>
    <div id="loader-overlay" class="hidden"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>
    <div id="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://assets.mixkit.co/videos/preview/mixkit-highway-in-the-middle-of-a-mountain-range-4633-large.mp4" type="video/mp4"> </video>
        <div id="login-container" class="p-4 p-md-5">
            <h2 class="text-center mb-1 fw-bold"><i class="fas fa-truck text-info"></i> Laser Power Truck Bidding</h2>
            <p class="text-center mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3 password-container">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                    <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3 small">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
        </div>
    </div>
    
    <div id="app-container" class="wrapper hidden"></div>

    <div class="modal fade" id="registerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="register-form"><div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="Shipper">Shipper (I have loads)</option><option value="Trucker">Trucker (I have trucks)</option></select></div><div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="reg-contact" class="form-control" placeholder="Contact Number" required></div><div class="mb-2 hidden" id="reg-company-wrapper"><input type="text" id="reg-company" class="form-control" placeholder="Company Name"></div><div class="mb-3 hidden" id="reg-gstin-wrapper"><input type="text" id="reg-gstin" class="form-control" placeholder="GSTIN (Optional)"></div><button type="submit" class="btn btn-success w-100 fw-bold">Register</button></form></div></div></div></div>
    <div class="modal fade" id="bulkUploadModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="bulk-upload-modal-title">Bulk Upload</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Please upload an Excel file. <a href="#" id="download-template-link">Download Template</a></p><hr><form id="bulk-upload-form"><input type="hidden" id="bulk-upload-type"><div class="mb-3"><label class="form-label">Select Excel File</label><input class="form-control" type="file" id="bulk-upload-file" accept=".xlsx, .xls" required></div><button type="submit" class="btn btn-success w-100">Upload and Submit</button></form></div></div></div></div>
    <div class="modal fade" id="addUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Add New User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="add-user-form"><div class="mb-3"><label class="form-label">Role</label><select id="add-role" class="form-select" required><option value="">Select...</option><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><input type="text" id="add-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="add-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="add-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="add-contact" class="form-control" placeholder="Contact"></div><div class="mb-2"><input type="text" id="add-company" class="form-control" placeholder="Company Name"></div><div class="mb-3"><input type="text" id="add-gstin" class="form-control" placeholder="GSTIN"></div><button type="submit" class="btn btn-success w-100 fw-bold">Create User</button></form></div></div></div></div>
    <div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-user-form"><input type="hidden" id="edit-userid"><div class="mb-2"><label>Name</label><input type="text" id="edit-fullname" class="form-control" required></div><div class="mb-2"><label>Email</label><input type="email" id="edit-email" class="form-control" required></div><div class="mb-2"><label>Role</label><select id="edit-role" class="form-select" required><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><label>Company</label><input type="text" id="edit-company" class="form-control"></div><div class="mb-2"><label>Contact</label><input type="text" id="edit-contact" class="form-control"></div><div class="mb-2"><label>GSTIN</label><input type="text" id="edit-gstin" class="form-control"></div><div class="mb-2"><label>New Password</label><input type="password" id="edit-password" class="form-control" placeholder="Leave blank to keep unchanged"></div><button type="submit" class="btn btn-success w-100">Save Changes</button></form></div></div></div></div>
    <div class="modal fade" id="masterDataModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="master-data-modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="master-data-form" data-type="" data-id=""><div class="mb-3"><label>Name</label><input type="text" id="master-name" class="form-control" required></div><div id="master-active-switch" class="form-check form-switch"><input class="form-check-input" type="checkbox" id="master-active"><label class="form-check-label" for="master-active">Is Active</label></div><button type="submit" class="btn btn-success w-100 mt-3">Save</button></form></div></div></div></div>
    <div class="modal fade" id="viewBidsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="viewBidsModalTitle">Bids for Load</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="viewBidsModalBody"></div></div></div></div>
    <div class="modal fade" id="assignTruckersModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="assignTruckersModalTitle">Assign Truckers</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="assign-trucker-req-id"><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.modal-body').find('.assign-trucker-checkbox').prop('checked', this.checked)" checked><label class="form-check-label">Select All Truckers</label></div><hr><div id="assign-trucker-checklist" class="border rounded p-3" style="max-height: 250px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" onclick="handleUpdateTruckerAssignments()">Save Changes</button></div></div></div></div>
    <div class="modal fade" id="advancedBulkAwardModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Advanced Bulk Award</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="text-muted">Select one winning bid for each load you wish to award.</p><div class="accordion" id="advanced-bulk-award-modal-body"></div></div><div class="modal-footer"><div class="w-100"><div class="mb-2"><label class="form-label">Remarks (Mandatory)</label><textarea id="advanced-bulk-award-remarks" class="form-control" rows="2" placeholder="e.g., Awarded based on best price."></textarea></div><div class="d-flex justify-content-end"><button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-success" onclick="handleSubmitAdvancedBulkAward()">Submit Awards</button></div></div></div></div></div></div>
    <div class="modal fade" id="reopenBiddingModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Re-open Bidding</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="reopen-load-ids"><div class="mb-3"><label class="form-label"><strong>Remarks (Mandatory)</strong></label><textarea id="reopen-remarks" class="form-control" rows="2"></textarea></div><div class="mb-3"><label class="form-label d-flex justify-content-between"><span>Select Truckers for New Bidding Round</span><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.modal-body').find('.reopen-trucker-checkbox').prop('checked', this.checked)"><label class="form-check-label small">Select All</label></div></label><div id="reopen-trucker-checklist" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-warning" onclick="submitReopenBidding()">Confirm & Re-open</button></div></div></div></div>
    <div class="modal fade" id="setBiddingTimeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Set/Update Bidding Time</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="setTimeLoadId"><p><strong>Load ID:</strong> <span id="setTimeLoadName"></span></p><div class="mb-3"><label class="form-label">Bidding Start Time</label><input type="datetime-local" id="setTimeStartTime" class="form-control"></div><div class="mb-3"><label class="form-label">Bidding Duration</label><select id="setTimeDuration" class="form-select"><option value="5">5 Minutes</option><option value="10">10 Minutes</option><option value="15" selected>15 Minutes</option><option value="20">20 Minutes</option><option value="30">30 Minutes</option><option value="45">45 Minutes</option><option value="60">60 Minutes</option></select></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" onclick="handleSetBiddingTimeSubmit()">Save Changes</button></div></div></div></div>
    <div class="modal fade" id="bulkSetTimeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Set Bulk Bidding Time</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>You are about to set the bidding time for <strong id="bulk-set-time-count"></strong> selected load(s).</p><div class="mb-3"><label class="form-label">Bidding Start Time</label><input type="datetime-local" id="bulkSetTimeStartTime" class="form-control"></div><div class="mb-3"><label class="form-label">Bidding Duration</label><select id="bulkSetTimeDuration" class="form-select"><option value="5">5 Minutes</option><option value="10">10 Minutes</option><option value="15" selected>15 Minutes</option><option value="20">20 Minutes</option><option value="30">30 Minutes</option><option value="45">45 Minutes</option><option value="60">60 Minutes</option></select></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-warning" onclick="handleBulkSetTimeSubmit()">Save Changes</button></div></div></div></div>
    <div class="modal fade" id="editLoadModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Load Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-load-form"><input type="hidden" id="edit-load-id"><div class="mb-3"><label class="form-label">Loading Point</label><input type="text" id="edit-loading-point" class="form-control" required></div><div class="mb-3"><label class="form-label">Unloading Point</label><input type="text" id="edit-unloading-point" class="form-control" required></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Material</label><select id="edit-material" class="form-select" required></select></div><div class="col-md-6 mb-3"><label class="form-label">Truck Type</label><select id="edit-truck-type" class="form-select" required></select></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Weight (Tonnes)</label><input type="number" id="edit-weight" class="form-control" step="0.1" required></div><div class="col-md-6 mb-3"><label class="form-label">Requirement Date</label><input type="date" id="edit-req-date" class="form-control" required></div></div><button type="submit" class="btn btn-primary w-100">Save Changes</button></form></div></div></div></div>
    <div class="modal fade" id="bulkApproveModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Bulk Approve & Assign Loads</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>You are about to approve <strong id="bulk-approve-count"></strong> selected "Pending Approval" load(s).</p><hr><div class="mb-3"><label class="form-label fw-bold">Bidding Start Time (Mandatory)</label><input type="datetime-local" id="bulkApproveStartTime" class="form-control" required></div><div class="mb-3"><label class="form-label fw-bold">Bidding Duration (Mandatory)</label><select id="bulkApproveDuration" class="form-select" required><option value="5">5 Minutes</option><option value="10">10 Minutes</option><option value="15" selected>15 Minutes</option><option value="20">20 Minutes</option><option value="30">30 Minutes</option><option value="45">45 Minutes</option><option value="60">60 Minutes</option></select></div><div class="mb-3"><label class="form-label fw-bold d-flex justify-content-between"><span>Assign Truckers</span><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.modal-body').find('.bulk-approve-trucker-checkbox').prop('checked', this.checked)" checked><label class="form-check-label small">Select All</label></div></label><div id="bulk-approve-trucker-checklist" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-success" onclick="handleBulkApproveSubmit()">Confirm & Approve</button></div></div></div></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        const API_BASE_URL = '/api';
        let loginWrapper, appContainer;
        let registerModal, editUserModal, addUserModal, bulkUploadModal, masterDataModal, viewBidsModal, assignTruckersModal, advancedBulkAwardModal, reopenBiddingModal, setBiddingTimeModal, bulkSetTimeModal, editLoadModal, bulkApproveModal;
        let charts = {};
        let truckerLoadsCache = [];
        let chatPollingInterval = null;
        let biddingTimers = [];
        let dataCache = {}; // Cache for table data to be downloaded

        const views = {
            'shipper-create-load-view': `<div class="card view"><div class="card-header"><h5 class="mb-0"><i class="fas fa-truck-loading me-2"></i>Post Load Requirements</h5></div><div class="card-body"><form id="load-request-form"><div id="load-items-container"></div><div class="d-flex justify-content-between mt-3"><button type="button" class="btn btn-outline-secondary" onclick="addLoadItem()"><i class="fas fa-plus me-2"></i>Add Another Load</button><button type="submit" class="btn btn-primary fw-bold">Submit All Load Requests</button></div></form></div></div>`,
            'shipper-status-view': `<div class="card view"><div class="card-header"><h5 class="mb-0"><i class="fas fa-history me-2"></i>My Load Request Status</h5></div><div class="card-body" id="shipper-req-status-list"></div></div>`,
            'trucker-dashboard-view': `<div class="row g-4 mb-4 view"><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-info" onclick="navigateTo('trucker-open-loads-view')"><div><h5 class="mb-0">Open for Bidding</h5><p class="display-4" id="trucker-stats-open">--</p></div><i class="fas fa-file-signature stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-primary" onclick="navigateTo('trucker-bidding-history-view')"><div><h5 class="mb-0">Bids Submitted</h5><p class="display-4" id="trucker-stats-submitted">--</p></div><i class="fas fa-gavel stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-success" onclick="navigateTo('trucker-awarded-contracts-view')"><div><h5 class="mb-0">Contracts Won</h5><p class="display-4" id="trucker-stats-won">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-warning" onclick="navigateTo('trucker-open-loads-view')"><div><h5 class="mb-0">Needs My Bid</h5><p class="display-4" id="trucker-stats-needs-bid">--</p></div><i class="fas fa-edit stat-icon"></i></div></div></div><div class="row g-4 view"><div class="col-lg-5"><div class="card h-100"><div class="card-header"><h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Performance Snapshot</h5></div><div class="card-body p-2"><ul class="list-group list-group-flush" id="trucker-kpi-container"></ul></div></div></div><div class="col-lg-7"><div class="card h-100"><div class="card-header d-flex justify-content-between"><span><i class="fas fa-history me-2"></i>My Recent Bids</span><button class="btn btn-sm btn-outline-primary" onclick="navigateTo('trucker-bidding-history-view')">View All</button></div><div class="card-body p-0"><div class="list-group list-group-flush" id="trucker-recent-bids"></div></div></div></div></div>`,
            'trucker-open-loads-view': `<div class="view"><div class="card mb-4 filters-card"><div class="card-body"><div class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label form-label-sm">Req. Start Date</label><input type="date" id="trucker-req-filter-start-date" class="form-control form-control-sm"></div><div class="col-md-4"><label class="form-label form-label-sm">Req. End Date</label><input type="date" id="trucker-req-filter-end-date" class="form-control form-control-sm"></div><div class="col-md-4"><button class="btn btn-primary btn-sm w-100" onclick="load_trucker_open_loads_view()">Apply Filters</button></div></div></div></div><div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"><h5>Open Loads for Bidding</h5><button class="btn btn-success" onclick="handleBulkBidSubmit()"><i class="fas fa-check-double me-2"></i>Submit Bids</button></div><div id="trucker-bidding-table-container" class="card"></div></div>`,
            'trucker-bidding-history-view': `<div class="view"><div class="card mb-4 filters-card"><div class="card-body"><div class="row g-3 align-items-end"><div class="col-md-3"><label class="form-label form-label-sm">Status</label><select id="trucker-bids-filter-status" class="form-select form-select-sm"><option value="">All Statuses</option><option value="Active">Active</option><option value="Awarded">Awarded</option></select></div><div class="col-md-3"><label class="form-label form-label-sm">Start Date</label><input type="date" id="trucker-bids-filter-start-date" class="form-control form-control-sm"></div><div class="col-md-3"><label class="form-label form-label-sm">End Date</label><input type="date" id="trucker-bids-filter-end-date" class="form-control form-control-sm"></div><div class="col-md-3"><button class="btn btn-primary btn-sm w-100" onclick="load_trucker_bidding_history_view()">Apply Filters</button></div></div></div></div><div class="card"><div class="card-header d-flex justify-content-between"><h5>My Bidding History</h5><button class="btn btn-sm btn-success" onclick="downloadTableData('trucker-bids-table', 'Bidding_History.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle" id="trucker-bids-table"><thead class="table-light"><tr><th>Load ID</th><th>In-house Req No.</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Weight</th><th>Req. Date</th><th>Company</th><th>My Bid</th><th>My Rank</th><th>L1 Bid</th><th>Status</th><th>Remarks</th><th>Date</th></tr></thead><tbody id="trucker-bids-tbody"></tbody></table></div><div id="trucker-bids-empty-state"></div></div></div></div>`,
            'trucker-awarded-contracts-view': `<div class="view"><div class="card mb-4 filters-card"><div class="card-body"><div class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label form-label-sm">Award Start Date</label><input type="date" id="trucker-awarded-filter-start-date" class="form-control form-control-sm"></div><div class="col-md-4"><label class="form-label form-label-sm">Award End Date</label><input type="date" id="trucker-awarded-filter-end-date" class="form-control form-control-sm"></div><div class="col-md-4"><button class="btn btn-primary btn-sm w-100" onclick="load_trucker_awarded_contracts_view()">Apply Filters</button></div></div></div></div><div class="card"><div class="card-header d-flex justify-content-between"><h5><i class="fas fa-trophy me-2"></i>My Awarded Contracts</h5><button class="btn btn-sm btn-success" onclick="downloadTableData('trucker-awarded-table', 'My_Contracts.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle" id="trucker-awarded-table"><thead class="table-light"><tr><th>Load ID</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Weight</th><th>Req. Date</th><th>Awarded Amount</th><th>Award Date</th></tr></thead><tbody id="trucker-awarded-tbody"></tbody></table></div><div id="trucker-awarded-empty-state"></div></div></div></div>`,
            'admin-dashboard-view': `<div class="row g-4 mb-4 view"><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-primary" onclick="navigateTo('admin-all-loads-view')"><div><h5 class="mb-0">Active Loads</h5><p class="display-4" id="stats-active-loads">--</p></div><i class="fas fa-truck stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-success" onclick="navigateTo('admin-user-approvals-view')"><div><h5 class="mb-0">Pending Users</h5><p class="display-4" id="stats-pending-users">--</p></div><i class="fas fa-user-check stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-warning" onclick="navigateTo('admin-pending-loads-view')"><div><h5 class="mb-0">Pending Loads</h5><p class="display-4" id="stats-pending-loads">--</p></div><i class="fas fa-inbox stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-info" onclick="navigateTo('admin-awarded-contracts-view')"><div><h5 class="mb-0">Loads Awarded</h5><p class="display-4" id="stats-awarded-contracts">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div></div><div class="row g-4"><div class="col-12"><div class="card"><div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Analytics Overview</h5></div><div class="card-body"><div class="row"><div class="col-lg-7 mb-4 mb-lg-0"><h6 class="text-muted text-center">Load Creation Trends</h6><div class="chart-container"><canvas id="adminLoadChart"></canvas></div></div><div class="col-lg-5"><h6 class="text-muted text-center">Top Trucker Bidding</h6><div class="chart-container"><canvas id="adminTruckerBiddingChart"></canvas></div></div></div></div></div></div></div>`,
            
            'admin-bulk-upload-history-view': `<div class="card view">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-history me-2"></i>Bulk Upload History</h5>
                    <button class="btn btn-primary" onclick="openBulkUploadModal('load')">
                        <i class="fas fa-upload me-2"></i>Bulk Upload Loads
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="admin-bulk-history-table">
                            <thead class="table-light">
                                <tr>
                                    <th>File Name</th>
                                    <th>Started at</th>
                                    <th>Completed at</th>
                                    <th>Uploaded by</th>
                                    <th>Status</th>
                                    <th>Total Rows</th>
                                    <th>Success</th>
                                    <th>Errors</th>
                                    <th>Error File</th>
                                </tr>
                            </thead>
                            <tbody id="admin-bulk-history-tbody"></tbody>
                        </table>
                    </div>
                    <div id="admin-bulk-history-empty-state"></div>
                </div>
            </div>`,

            'admin-pending-loads-view': `<div class="card view"><div class="card-header d-flex justify-content-between"><h5>Pending Load Approvals</h5><button class="btn btn-sm btn-success" onclick="openBulkApproveModal()"><i class="fas fa-check-double me-2"></i>Approve Selected</button></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle" id="admin-pending-loads-table"><thead class="table-light"><tr><th><input type="checkbox" onchange="$(this).closest('table').find('.load-checkbox').prop('checked', this.checked)"></th><th>In-house Req No.</th><th>Load ID</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Weight</th><th>Req. Date</th><th>Remarks</th></tr></thead><tbody id="admin-pending-loads-tbody"></tbody></table></div><div id="admin-pending-loads-empty-state"></div></div></div>`,
            'admin-all-loads-view': `<div class="view"><div class="card mb-4 filters-card"><div class="card-body"><div class="row g-3 align-items-end"><div class="col-lg-3 col-md-6 col-12"><label class="form-label form-label-sm">Status</label><select id="admin-loads-filter-status" class="form-select form-select-sm"><option value="Active" selected>Active</option><option value="Awarded">Awarded</option><option value="Pending Approval">Pending Approval</option></select></div><div class="col-lg-3 col-md-6 col-12"><label class="form-label form-label-sm">Req. Start Date</label><input type="date" id="admin-loads-filter-start-date" class="form-control form-control-sm"></div><div class="col-lg-3 col-md-6 col-12"><label class="form-label form-label-sm">Req. End Date</label><input type="date" id="admin-loads-filter-end-date" class="form-control form-control-sm"></div><div class="col-lg-3 col-md-6 col-12"><button class="btn btn-primary btn-sm w-100" onclick="load_admin_all_loads_view()">Apply Filters</button></div></div></div></div><div class="card"><div class="card-header d-flex justify-content-between flex-wrap gap-2"><h5>All Loads</h5><div><button class="btn btn-sm btn-warning" onclick="openBulkSetTimeModal()"><i class="fas fa-clock me-2"></i>Set Bulk Time</button><button class="btn btn-sm btn-success ms-2" onclick="openAdvancedBulkAwardModal()"><i class="fas fa-trophy me-2"></i>Award Selected</button><button class="btn btn-sm btn-info ms-2" onclick="downloadTableData('admin-loads-table', 'All_Loads_Report.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle" id="admin-loads-table"><thead class="table-light"><tr><th><input type="checkbox" onchange="$(this).closest('table').find('.load-checkbox').prop('checked', this.checked)"></th><th>In-house Req No.</th><th>Load ID</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Weight</th><th>Req. Date</th><th>Status</th><th>L1 Bid</th><th>Remarks</th><th>Actions</th></tr></thead><tbody id="admin-loads-tbody"></tbody></table></div><div id="admin-loads-empty-state"></div></div></div></div>`,
            
            'admin-manage-loads-view': `<div class="view"><div class="card"><div class="card-header"><h5><i class="fas fa-edit me-2"></i>Manage Loads</h5></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle" id="admin-manage-loads-table"><thead class="table-light"><tr><th>In-house Req No.</th><th>Load ID</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Weight</th><th>Req. Date</th><th>Status</th><th>Remarks</th><th>Actions</th></tr></thead><tbody id="admin-manage-loads-tbody"></tbody></table></div><div id="admin-manage-loads-empty-state"></div></div></div></div>`,
            'admin-bidding-history-view': `<div class="view"><div class="card mb-4 filters-card"><div class="card-body"><div class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label form-label-sm">Start Date</label><input type="date" id="admin-bids-filter-start-date" class="form-control form-control-sm"></div><div class="col-md-4"><label class="form-label form-label-sm">End Date</label><input type="date" id="admin-bids-filter-end-date" class="form-control form-control-sm"></div><div class="col-md-4"><button class="btn btn-primary btn-sm w-100" onclick="load_admin_bidding_history_view()">Apply Filters</button></div></div></div></div><div class="card"><div class="card-header d-flex justify-content-between"><h5>Platform Bidding History</h5><button class="btn btn-sm btn-success" onclick="downloadTableData('admin-bids-table', 'Bidding_History.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle" id="admin-bids-table"><thead class="table-light"><tr><th>In-house Req No.</th><th>Load ID</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Req. Date</th><th>Trucker</th><th>Company</th><th>Bid Amount</th><th>Remarks</th><th>Date</th></tr></thead><tbody id="admin-bids-tbody"></tbody></table></div><div id="admin-bids-empty-state"></div></div></div></div>`,
            'admin-awarded-contracts-view': `<div class="view"><div class="card mb-4 filters-card"><div class="card-body"><div class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label form-label-sm">Start Date</label><input type="date" id="admin-awarded-filter-start-date" class="form-control form-control-sm"></div><div class="col-md-4"><label class="form-label form-label-sm">End Date</label><input type="date" id="admin-awarded-filter-end-date" class="form-control form-control-sm"></div><div class="col-md-4"><button class="btn btn-primary btn-sm w-100" onclick="load_admin_awarded_contracts_view()">Apply Filters</button></div></div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><h5>All Awarded Contracts</h5><div><button class="btn btn-sm btn-danger" onclick="openReopenBiddingModal()"><i class="fas fa-history me-2"></i>Re-open Selected</button><button class="btn btn-sm btn-success ms-2" onclick="downloadTableData('admin-awarded-table', 'Awarded_Contracts_Report.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle" id="admin-awarded-table"><thead class="table-light"><tr><th><input type="checkbox" onchange="$(this).closest('table').find('.awarded-load-checkbox').prop('checked', this.checked)"></th><th>In-house Req No.</th><th>Load ID</th><th>Trucker</th><th>Contact</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Req. Date</th><th>Amount</th><th>Award Date</th><th>Actions</th></tr></thead><tbody id="admin-awarded-tbody"></tbody></table></div><div id="admin-awarded-empty-state"></div></div></div></div>`,
            'admin-reports-view': `<div class="card view"><div class="card-header d-flex justify-content-between"><h5>Reports & Analytics</h5><button class="btn btn-sm btn-success" onclick="downloadReport()"><i class="fas fa-download me-2"></i>Download Detailed Report</button></div><div class="card-body"><div class="row g-3 align-items-center border p-3 rounded mb-4"><div class="col-md-5"><label class="form-label-sm">Start Date</label><input type="date" id="report-start-date" class="form-control form-control-sm"></div><div class="col-md-5"><label class="form-label-sm">End Date</label><input type="date" id="report-end-date" class="form-control form-control-sm"></div><div class="col-md-2 d-grid"><button id="report-apply-filter" class="btn btn-primary btn-sm mt-md-3">Apply</button></div></div><div class="row g-4" id="report-kpis"></div><hr class="my-4"><div class="row g-5"><div class="col-lg-4"><h5 class="text-center text-muted mb-3">Top 5 Truckers (by Wins)</h5><div class="chart-container" style="height:300px;"><canvas id="top-truckers-chart"></canvas></div></div><div class="col-lg-8"><h5 class="text-center text-muted mb-3">Spend by Material</h5><div class="chart-container" style="height:300px;"><canvas id="spend-material-chart"></canvas></div></div><div class="col-12 mt-4"><h5 class="text-center text-muted mb-3">Total Spend Over Time</h5><div class="chart-container" style="height:300px;"><canvas id="spend-time-chart"></canvas></div></div></div><div class="mt-5"><h5 class="text-center text-muted">Detailed Report</h5><div class="table-responsive"><table class="table table-sm table-striped" id="detailed-report-table"><thead><tr><th>In-house Req No.</th><th>Load ID</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Truck Type</th><th>Weight</th><th>Req. Date</th><th>Trucker</th><th>Awarded Amount</th><th>Remarks</th><th>Award Date</th></tr></thead><tbody></tbody></table></div></div></div></div>`,
            'admin-master-data-view': `<div class="row view"><div class="col-md-6 mb-4 mb-md-0"><div class="card"><div class="card-header d-flex justify-content-between"><span>Material Types</span><div><button class="btn btn-info btn-sm me-2" onclick="openBulkUploadModal('item')"><i class="fas fa-upload"></i></button><button class="btn btn-success btn-sm" onclick="openMasterDataModal('item')"><i class="fas fa-plus"></i></button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover"><tbody id="item-master-tbody"></tbody></table></div></div></div><div class="col-md-6"><div class="card"><div class="card-header d-flex justify-content-between"><span>Truck Types</span><div><button class="btn btn-info btn-sm me-2" onclick="openBulkUploadModal('truck')"><i class="fas fa-upload"></i></button><button class="btn btn-success btn-sm" onclick="openMasterDataModal('truck')"><i class="fas fa-plus"></i></button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover"><tbody id="truck-master-tbody"></tbody></table></div></div></div></div>`,
            'admin-user-approvals-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">Pending User Approvals</h5></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>Action</th></tr></thead><tbody id="admin-pending-users-tbody"></tbody></table></div><div id="admin-pending-users-empty-state"></div></div></div>`,
            'admin-user-control-view': `<div class="card view"><div class="card-header d-flex justify-content-between align-items-center"><h5>User Control Center</h5><button class="btn btn-success btn-sm" onclick="openAddUserModal()"><i class="fas fa-plus me-2"></i>Add User</button></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>GSTIN</th><th>Action</th></tr></thead><tbody id="admin-users-tbody"></tbody></table></div><div id="admin-users-empty-state"></div></div></div>`,
            'messaging-view': `<div class="card view" style="height: calc(100vh - 125px);"><div class="row g-0 h-100"><div class="col-lg-4 col-12 border-end d-flex flex-column"><div class="p-3 border-bottom bg-light"><input type="search" id="chat-search-bar" class="form-control" placeholder="Search chats..."></div><div id="chat-list" class="list-group list-group-flush" style="overflow-y: auto; flex-grow: 1;"></div></div><div class="col-lg-8 col-12 d-flex flex-column"><div id="chat-main" class="h-100"><div id="chat-welcome" class="d-flex align-items-center justify-content-center h-100"><div class="text-center text-muted"><i class="fab fa-whatsapp fa-3x mb-3"></i><p>Select a conversation to start messaging.</p></div></div><div id="chat-window" class="d-none h-100 d-flex flex-column"><div class="card-header d-flex align-items-center border-bottom bg-light"><h5 id="chat-with-name" class="mb-0"></h5></div><div id="chat-messages" class="card-body" style="overflow-y: auto; flex-grow: 1;"></div><div class="card-footer bg-light p-3 border-top"><form id="message-form" class="d-flex"><input type="text" id="message-input" class="form-control" placeholder="Type a message..." autocomplete="off" required><button type="submit" class="btn btn-primary ms-2"><i class="fas fa-paper-plane"></i></button></form></div></div></div></div></div></div>`
        };
        
        $(document).ready(() => {
            loginWrapper = $('#login-wrapper');
            appContainer = $('#app-container');
            try {
                registerModal = new bootstrap.Modal('#registerModal');
                bulkUploadModal = new bootstrap.Modal('#bulkUploadModal');
                addUserModal = new bootstrap.Modal('#addUserModal');
                editUserModal = new bootstrap.Modal('#editUserModal');
                masterDataModal = new bootstrap.Modal('#masterDataModal');
                viewBidsModal = new bootstrap.Modal('#viewBidsModal');
                assignTruckersModal = new bootstrap.Modal('#assignTruckersModal');
                advancedBulkAwardModal = new bootstrap.Modal('#advancedBulkAwardModal');
                reopenBiddingModal = new bootstrap.Modal('#reopenBiddingModal');
                setBiddingTimeModal = new bootstrap.Modal('#setBiddingTimeModal');
                bulkSetTimeModal = new bootstrap.Modal('#bulkSetTimeModal');
                editLoadModal = new bootstrap.Modal('#editLoadModal');
                bulkApproveModal = new bootstrap.Modal('#bulkApproveModal');
            } catch (e) { console.error("Error initializing modals:", e); }
            const user = sessionStorage.getItem('loggedInUser');
            if (user && sessionStorage.getItem('authToken')) {
                setupUIForRole(JSON.parse(user));
            } else {
                loginWrapper.removeClass('hidden');
                appContainer.addClass('hidden');
            }
            $('#login-form').on('submit', handleLogin);
            $('#register-form').on('submit', handleRegistration);
            $('#reg-role').on('change', handleRoleChange);
            $('#togglePassword').on('click', function() {
                const p = $('#password');
                p.attr('type', p.attr('type') === 'password' ? 'text' : 'password');
                $(this).toggleClass('fa-eye-slash fa-eye');
            });
            $(document).on('submit', '#load-request-form', handleLoadSubmit);
            $(document).on('submit', '#add-user-form', handleAddUserSubmit);
            $(document).on('submit', '#edit-user-form', handleUserUpdateSubmit);
            $(document).on('submit', '#bulk-upload-form', handleBulkUpload);
            $(document).on('click', '#report-apply-filter', load_admin_reports_view);
            $(document).on('submit', '#master-data-form', handleMasterDataSubmit);
            $(document).on('keyup', '#chat-search-bar', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('#chat-list .list-group-item').each(function() {
                    const name = $(this).find('.chat-user-name').text().toLowerCase();
                    $(this).toggle(name.includes(searchTerm));
                });
            });
            $(document).on('submit', '#edit-load-form', async function(e) {
                e.preventDefault();
                const loadId = $('#edit-load-id').val();
                const data = {
                    loading_point_address: $('#edit-loading-point').val(),
                    unloading_point_address: $('#edit-unloading-point').val(),
                    item_id: $('#edit-material').val(),
                    truck_type_id: $('#edit-truck-type').val(),
                    approx_weight_tonnes: $('#edit-weight').val(),
                    requirement_date: $('#edit-req-date').val()
                };

                try {
                    await apiCall(`/loads/${loadId}`, 'PUT', data);
                    showToast('Load updated successfully!', 'success');
                    editLoadModal.hide();
                    load_admin_manage_loads_view(); 
                } catch (error) {
                }
            });

            $(document).on('click', '.send-email-btn', function() {
                try {
                    const contractString = $(this).attr('data-contract');
                    const contractData = JSON.parse(contractString);
                    sendAwardConfirmation(contractData);
                } catch (e) {
                    console.error("Failed to parse contract data for email:", e);
                    showToast("Error reading contract details.", "error");
                }
            });
        });

        async function apiCall(endpoint, method = 'GET', body = null, isFormData = false, showLoaderFlag = true) {
            if(showLoaderFlag) showLoader();
            try {
                const headers = {};
                const token = sessionStorage.getItem('authToken');
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                let url = API_BASE_URL + endpoint;
                const options = { method, headers };

                if (method.toUpperCase() === 'GET' && body) {
                    const params = new URLSearchParams();
                    for (const key in body) {
                        if (body[key]) {
                            params.append(key, body[key]);
                        }
                    }
                    if (params.toString()) {
                        url += '?' + params.toString();
                    }
                } else if (body) {
                    if (!isFormData) headers['Content-Type'] = 'application/json';
                    options.body = isFormData ? body : JSON.stringify(body);
                }

                const response = await fetch(url, options);
                if (response.status === 204) return { success: true };
                if (response.status === 202) return await response.json();

                const resultText = await response.text();
                let result;
                try {
                    result = JSON.parse(resultText);
                } catch (e) {
                    throw new Error("Received an invalid response from the server.");
                }

                if (!response.ok) {
                    if (response.status === 401 && !endpoint.includes('/login')) {
                        showToast('Session expired. Logging out.', 'error');
                        setTimeout(handleLogout, 2000);
                    }
                    throw new Error(result.message || 'Server error');
                }
                return result;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                if(showLoaderFlag) hideLoader();
            }
        }

        function navigateTo(viewId) {
            if (!views[viewId]) return console.error("View not found:", viewId);
            if (chatPollingInterval) clearInterval(chatPollingInterval);
            biddingTimers.forEach(timer => clearInterval(timer));
            biddingTimers = [];
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            dataCache = {}; // Clear data cache on navigation
            $('#main-view').html(views[viewId]);
            $('#nav-links .nav-link').removeClass('active');
            const navLink = $(`[data-view="${viewId}"]`);
            if (navLink.length) {
                navLink.addClass('active');
                $('#header-title').text(navLink.find('span').text().trim());
            }
            const loadFunctionName = `load_${viewId.replace(/-/g, '_')}`;
            if (typeof window[loadFunctionName] === 'function') {
                window[loadFunctionName]();
            }
        }
        
        async function handleLogin(e) { e.preventDefault(); try { const result = await apiCall('/login', 'POST', { email: $('#email').val(), password: $('#password').val() }); sessionStorage.setItem('loggedInUser', JSON.stringify(result.user)); sessionStorage.setItem('authToken', result.token); await setupUIForRole(result.user); } catch (error) {} }
        function handleLogout() { if (chatPollingInterval) clearInterval(chatPollingInterval); sessionStorage.clear(); window.location.reload(); }
        function handleRoleChange() { const isTrucker = $('#reg-role').val() === 'Trucker'; $('#reg-company-wrapper, #reg-gstin-wrapper').toggleClass('hidden', !isTrucker); $('#reg-company').prop('required', isTrucker); }
        async function handleRegistration(e) { e.preventDefault(); const data = { FullName: $('#reg-fullname').val(), Email: $('#reg-email').val(), Password: $('#reg-password').val(), Role: $('#reg-role').val(), CompanyName: $('#reg-company').val(), ContactNumber: $('#reg-contact').val(), GSTIN: $('#reg-gstin').val() }; try { await apiCall('/register', 'POST', data); showToast('Registration successful! Awaiting admin approval.', 'success'); registerModal.hide(); $(e.target)[0].reset(); } catch (e) {} }
        
        function setupUIForRole(user) {
            loginWrapper.addClass('hidden');
            appContainer.removeClass('hidden');
            const roleNavs = {
                'Shipper': `<a class="nav-link" data-view="shipper-create-load-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-plus-circle"></i> <span>Post New Loads</span></div></a><a class="nav-link" data-view="shipper-status-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-history"></i> <span>My Load Status</span></div></a><a class="nav-link" data-view="messaging-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-comments"></i> <span>Messages</span></div><span class="badge bg-danger rounded-pill" id="badge-unread-messages"></span></a>`,
                'Trucker': `<a class="nav-link" data-view="trucker-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a><a class="nav-link" data-view="trucker-open-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-truck-loading"></i> <span>Open Loads</span></div></a><a class="nav-link" data-view="trucker-bidding-history-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-gavel"></i> <span>Bidding History</span></div></a><a class="nav-link" data-view="trucker-awarded-contracts-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-trophy"></i> <span>My Contracts</span></div></a><a class="nav-link" data-view="messaging-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-comments"></i> <span>Messages</span></div><span class="badge bg-danger rounded-pill" id="badge-unread-messages"></span></a>`,
                'Admin': `<a class="nav-link" data-view="admin-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a><a class="nav-link" data-view="admin-bulk-upload-history-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-upload"></i> <span>Bulk Uploads</span></div></a><a class="nav-link" data-view="admin-pending-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-inbox"></i> <span>Load Approvals</span></div><span class="badge bg-warning rounded-pill" id="badge-pending-loads"></span></a><a class="nav-link" data-view="admin-all-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-list-alt"></i> <span>All Loads</span></div></a><a class="nav-link" data-view="admin-manage-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-edit"></i> <span>Manage Loads</span></div></a><a class="nav-link" data-view="admin-bidding-history-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-history"></i> <span>Bidding History</span></div></a><a class="nav-link" data-view="admin-awarded-contracts-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-trophy"></i> <span>Awarded Contracts</span></div></a><a class="nav-link" data-view="admin-reports-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-chart-line"></i> <span>Reports</span></div></a><a class="nav-link" data-view="admin-master-data-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-database"></i> <span>Master Data</span></div></a><a class="nav-link" data-view="admin-user-approvals-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-user-check"></i> <span>User Approvals</span></div><span class="badge bg-warning rounded-pill" id="badge-pending-users"></span></a><a class="nav-link" data-view="admin-user-control-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-users-cog"></i> <span>User Control</span></div></a><a class="nav-link" data-view="messaging-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-comments"></i> <span>Messages</span></div><span class="badge bg-danger rounded-pill" id="badge-unread-messages"></span></a>`,
            };
            roleNavs['Super Admin'] = roleNavs['Admin'];
            const appHTML = `
                <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
                <nav class="sidebar" id="sidebar">
                    <div class="logo"><i class="fas fa-truck"></i> <span>Laser Power Truck Bidding</span></div>
                    <div id="nav-links" class="flex-grow-1">${roleNavs[user.role] || ''}</div>
                </nav>
                <div class="main-content-wrapper">
                    <header class="top-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-bars" id="sidebar-toggle" onclick="toggleSidebar()"></i>
                            <h1 id="header-title" class="h4 mb-0 fw-bold text-dark ms-3"></h1>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="handleManualRefresh()"><i class="fas fa-sync-alt"></i></button>
                            <div class="dropdown user-dropdown">
                                <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="https://img.icons8.com/color/48/user-male-circle--v1.png" alt="user" width="32" height="32" class="rounded-circle">
                                </a>
                                <ul class="dropdown-menu text-small dropdown-menu-end" aria-labelledby="dropdownUser1">
                                    <li class="px-3 pt-2 pb-1">
                                        <div class="fw-bold">${user.full_name}</div>
                                        <div class="text-muted small">${user.email}</div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </header>
                    <main class="main-content" id="main-content">
                        <div id="main-view"></div>
                    </main>
                </div>`;
            appContainer.html(appHTML);
            const defaultViewMap = { 'Shipper': 'shipper-create-load-view', 'Trucker': 'trucker-dashboard-view', 'Admin': 'admin-dashboard-view', 'Super Admin': 'admin-dashboard-view' };
            navigateTo(defaultViewMap[user.role]);
            setInterval(fetchSidebarCounts, 60000);
            fetchSidebarCounts();
        }

        function toggleSidebar() {
            const wrapper = document.getElementById('app-container');
            if (window.innerWidth <= 768) {
                wrapper.classList.toggle('sidebar-mobile-open');
            } else {
                wrapper.classList.toggle('sidebar-collapsed');
            }
        }

        async function handleManualRefresh() { const currentViewLink = $('#nav-links .nav-link.active'); if (currentViewLink.length > 0) { showToast('Refreshing data...', 'info'); navigateTo(currentViewLink.data('view')); } }
        async function load_shipper_create_load_view() { try { await Promise.all([apiCall('/master-data/truck-types', 'GET', null, false, false), apiCall('/master-data/items', 'GET', null, false, false)]); $('#load-items-container').html(''); addLoadItem(); } catch (e) { $('#load-request-form').html('<div class="alert alert-danger">Could not load required data. Please refresh.</div>'); } }
        
        async function addLoadItem() { 
            const itemIndex = $('#load-items-container .card').length; 
            const [trucks, items] = await Promise.all([apiCall('/master-data/truck-types', 'GET', null, false, false), apiCall('/master-data/items', 'GET', null, false, false)]); 
            const truckOptions = trucks.data.filter(t => t.is_active).map(t => `<option value="${t.truck_type_id}">${t.truck_name}</option>`).join(''); 
            const itemOptions = items.data.filter(i => i.is_active).map(i => `<option value="${i.item_id}">${i.item_name}</option>`).join(''); 
            const today = new Date().toISOString().split('T')[0]; 
            const itemHtml = `<div class="card card-body mb-3">
                <div class="d-flex justify-content-end">${itemIndex > 0 ? `<button type="button" class="btn-close" onclick="$(this).closest('.card').remove()"></button>` : ''}</div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">Loading Point</label><input type="text" class="form-control loading_point_address" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">Unloading Point</label><input type="text" class="form-control unloading_point_address" required></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">Material</label><select class="form-select item_id" required><option value="">Select...</option>${itemOptions}</select></div>
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">Truck Type</label><select class="form-select truck_type_id" required><option value="">Select...</option>${truckOptions}</select></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">Weight (Tonnes)</label><input type="number" class="form-control approx_weight_tonnes" step="0.1" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">Requirement Date</label><input type="date" class="form-control requirement_date" min="${today}" value="${today}" required></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">In-house Requisition No.</label><input type="text" class="form-control inhouse_requisition_no"></div>
                    <div class="col-md-6 mb-3"><label class="form-label fw-bold">Remarks</label><input type="text" class="form-control remarks"></div>
                </div>
            </div>`; 
            $('#load-items-container').append(itemHtml); 
            $('#load-items-container .item_id, #load-items-container .truck_type_id').select2({ theme: 'bootstrap-5' }); 
        }
        
        async function handleLoadSubmit(e) { 
            e.preventDefault(); 
            const loads = []; 
            $('#load-items-container .card').each(function() { 
                const card = $(this); 
                loads.push({ 
                    loading_point_address: card.find('.loading_point_address').val(), 
                    unloading_point_address: card.find('.unloading_point_address').val(), 
                    item_id: card.find('.item_id').val(), 
                    truck_type_id: card.find('.truck_type_id').val(), 
                    approx_weight_tonnes: card.find('.approx_weight_tonnes').val(), 
                    requirement_date: card.find('.requirement_date').val(),
                    inhouse_requisition_no: card.find('.inhouse_requisition_no').val(),
                    remarks: card.find('.remarks').val()
                }); 
            }); 
            if (loads.length === 0) return showToast('Please add at least one load.', 'warning'); 
            try { 
                await apiCall('/loads', 'POST', { items: JSON.stringify(loads) }); 
                showToast(`${loads.length} load request(s) submitted!`, 'success'); 
                navigateTo('shipper-create-load-view'); 
            } catch (e) {} 
        }

        async function load_shipper_status_view() { const listDiv = $('#shipper-req-status-list'); try { renderEmptyState(listDiv, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/shipper/status'); if (result.data.length === 0) return renderEmptyState(listDiv, 'You have not posted any loads yet.', 'fa-file-signature'); listDiv.html(result.data.map(req => `<div class="card mb-3 view"><div class="card-header d-flex justify-content-between"><strong>TRN: REQ-${req.requisition_id}</strong><small>${formatDate(req.created_at)}</small></div><ul class="list-group list-group-flush">${req.loads.map(load => `<li class="list-group-item"><div class="d-flex w-100 justify-content-between"><div class="me-3" style="text-align: left;"><h6 class="mb-0">${load.item_name} (Load ID: ${load.load_id})</h6><small>${load.loading_point_address} <i class="fas fa-long-arrow-alt-right"></i> ${load.unloading_point_address}</small></div><span class="badge bg-${getBadgeColor(load.status)} align-self-center">${load.status}</span></div>${load.status === 'Awarded' ? `<small class="d-block text-success mt-1" style="text-align: left;"><i class="fas fa-trophy me-1"></i>Awarded to: ${load.awarded_vendor || 'N/A'} for <strong>${formatCurrency(load.awarded_amount)}</strong></small>` : ''}</li>`).join('')}</ul></div>`).join('')); } catch (e) {} }
        async function load_trucker_dashboard_view() { try { const result = await apiCall('/trucker/dashboard-stats'); const data = result.data; $('#trucker-stats-open').text(data.assignedLoads || '0'); $('#trucker-stats-submitted').text(data.submittedBids || '0'); $('#trucker-stats-won').text(data.contractsWon || '0'); $('#trucker-stats-needs-bid').text(data.needsBid || '0'); $('#trucker-kpi-container').html(data.kpis.map(kpi => `<li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="fas ${kpi.icon} text-${kpi.color} me-3"></i>${kpi.title}</span><span class="fw-bold h5 mb-0">${kpi.value}</span></li>`).join('') || '<li class="list-group-item text-center text-muted">No data.</li>'); $('#trucker-recent-bids').html(data.recentBids.map(bid => `<a href="#" class="list-group-item list-group-item-action"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 small">${bid.load_id}</h6><span class="badge bg-${getBadgeColor(bid.status)}">${bid.status || 'N/A'}</span></div><p class="mb-1 small text-muted">My Bid: ${formatCurrency(bid.bid_amount)}</p></a>`).join('') || '<div class="list-group-item text-center text-muted small">No recent bids.</div>'); } catch (e) {} }
        async function load_trucker_open_loads_view() { const container = $('#trucker-bidding-table-container'); try { renderEmptyState(container, 'Loading...', 'fa-spinner fa-spin'); const filters = { startDate: $('#trucker-req-filter-start-date').val(), endDate: $('#trucker-req-filter-end-date').val() }; const result = await apiCall('/loads/assigned', 'GET', filters); truckerLoadsCache = result.data; if (truckerLoadsCache.length === 0) { container.html(renderEmptyState(null, 'No loads assigned for bidding.', 'fa-truck-loading')); return; } renderBiddingTable(truckerLoadsCache); } catch (e) {} }
        function renderBiddingTable(loads) { biddingTimers.forEach(timer => clearInterval(timer)); biddingTimers = []; const container = $('#trucker-bidding-table-container'); const tableHTML = `<div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Load ID</th><th>In-house Req No.</th><th>Loading Point</th><th>Unloading Point</th><th>Material</th><th>Weight</th><th>Vehicle</th><th>Req. Date</th><th>Remarks</th><th>History</th><th>My Rank</th><th>My Bid / Status</th></tr></thead><tbody>${loads.map(load => { const history = (load.my_bid_history || []).map((b, i) => `<li>Bid ${i + 1}: <strong>${formatCurrency(b.bid_amount)}</strong> (Rank: L${b.rank || 'N/A'})</li>`).join(''); return `<tr data-load-id="${load.load_id}"><td>${load.load_id}</td><td>${load.inhouse_requisition_no || '-'}</td><td><small>${load.loading_point_address}</small></td><td><small>${load.unloading_point_address}</small></td><td><small>${load.item_name}</small></td><td><small>${load.approx_weight_tonnes}T</small></td><td><small>${load.truck_name}</small></td><td><small>${formatDate(load.requirement_date)}</small></td><td>${load.remarks || '-'}</td><td><button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="popover" data-bs-html="true" title="My Bidding History" data-bs-content="${history || 'No past bids.'}"><i class="fas fa-history"></i></button></td><td><span class="badge bg-${load.my_rank ? 'primary' : 'secondary'}">${load.my_rank ? `L${load.my_rank}` : 'N/A'}</span></td><td class="bidding-status-cell" data-start-time="${load.bidding_start_time}" data-end-time="${load.bidding_end_time}">${renderBidInput(load)}</td></tr>` }).join('')}</tbody></table></div>`; container.html(tableHTML); $('[data-bs-toggle="popover"]').popover({ trigger: 'hover focus' }); updateBiddingTimers(); }
        function renderBidInput(load) { const now = new Date(); const startTime = load.bidding_start_time ? new Date(load.bidding_start_time.replace(' ', 'T')) : null; const endTime = load.bidding_end_time ? new Date(load.bidding_end_time.replace(' ', 'T')) : null; if (endTime && now > endTime) { return `<span class="text-danger fw-bold small"><i class="fas fa-clock me-1"></i>Bidding Closed</span>`; } if (startTime && now < startTime) { return `<span class="text-info fw-bold small countdown-timer" data-start-time-raw="${load.bidding_start_time}">Starts in...</span>`; } if (startTime && endTime && now >= startTime && now < endTime) { return `<div class="live-bidding-container"><span class="text-success fw-bold small live-countdown-timer" data-end-time-raw="${load.bidding_end_time}"><i class="fas fa-hourglass-half me-1"></i>Calculating...</span><div class="input-group input-group-sm mt-1"><span class="input-group-text"></span><input type="number" class="form-control bid-amount-input" placeholder="Amount"></div></div>`; } return `<div class="input-group input-group-sm"><span class="input-group-text"></span><input type="number" class="form-control bid-amount-input" placeholder="Amount"></div>`; }
        function updateBiddingTimers() { biddingTimers.forEach(timer => clearInterval(timer)); biddingTimers = []; $('.countdown-timer').each(function() { const timerElement = $(this); const startTimeString = timerElement.data('start-time-raw'); if (!startTimeString) return; const startTime = new Date(startTimeString.replace(' ', 'T')); const interval = setInterval(() => { const now = new Date(); const diff = startTime - now; if (diff <= 0) { clearInterval(interval); const loadId = timerElement.closest('tr').data('load-id'); const load = truckerLoadsCache.find(l => l.load_id == loadId); if(load) timerElement.parent().html(renderBidInput(load)); updateBiddingTimers(); } else { const d = Math.floor(diff / (1000 * 60 * 60 * 24)); const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)); const s = Math.floor((diff % (1000 * 60)) / 1000); timerElement.html(`<i class="fas fa-hourglass-start me-1"></i>Starts in: ${d > 0 ? d + 'd ' : ''}${h}h ${m}m ${s}s`); } }, 1000); biddingTimers.push(interval); }); $('.live-countdown-timer').each(function() { const timerElement = $(this); const endTimeString = timerElement.data('end-time-raw'); if (!endTimeString) return; const endTime = new Date(endTimeString.replace(' ', 'T')); const interval = setInterval(() => { const now = new Date(); const diff = endTime - now; if (diff <= 0) { clearInterval(interval); timerElement.closest('td').html(`<span class="text-danger fw-bold small"><i class="fas fa-clock me-1"></i>Bidding Closed</span>`); } else { const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)); const s = Math.floor((diff % (1000 * 60)) / 1000); timerElement.html(`<i class="fas fa-hourglass-half me-1"></i>Closes in: ${m}m ${s}s`); } }, 1000); biddingTimers.push(interval); }); }
        async function handleBulkBidSubmit() { const bids = $('.bid-amount-input').map(function() { if ($(this).val()) { const loadId = $(this).closest('[data-load-id]').data('load-id'); return { loadId: loadId, bid_amount: parseFloat($(this).val()) }; } }).get(); if (bids.length === 0) return showToast('No new bids entered.', 'info'); try { const result = await apiCall('/bids', 'POST', { bids }); showToast(result.message, 'success'); load_trucker_open_loads_view(); } catch (e) {} }
        async function load_trucker_bidding_history_view() { const tbody = $('#trucker-bids-tbody'), empty = $('#trucker-bids-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().parent().hide(); const filters = { status: $('#trucker-bids-filter-status').val(), startDate: $('#trucker-bids-filter-start-date').val(), endDate: $('#trucker-bids-filter-end-date').val() }; const result = await apiCall('/trucker/bidding-history', 'GET', filters); dataCache['trucker-bids-table'] = result.data; if (result.data.length === 0) { tbody.parent().parent().show(); return renderEmptyState(empty, 'No bidding history found.', 'fa-gavel');} tbody.html(result.data.map(b => `<tr><td>${b.load_id}</td><td>${b.inhouse_requisition_no || '-'}</td><td>${b.loading_point_address}</td><td>${b.unloading_point_address}</td><td>${b.item_name}</td><td>${b.truck_name}</td><td>${b.approx_weight_tonnes}T</td><td>${formatDate(b.requirement_date)}</td><td>${b.company_name || '-'}</td><td><strong>${formatCurrency(b.bid_amount)}</strong></td><td><span class="badge bg-info">L${b.rank || 'N/A'}</span></td><td>${b.l1_bid ? formatCurrency(b.l1_bid) : '-'}</td><td><span class="badge bg-${getBadgeColor(b.status)}">${b.status}</span></td><td>${b.remarks || '-'}</td><td>${formatDate(b.submitted_at, true)}</td></tr>`).join('')); tbody.parent().parent().show(); empty.empty(); } catch (e) {} }
        async function load_trucker_awarded_contracts_view() { const tbody = $('#trucker-awarded-tbody'), empty = $('#trucker-awarded-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().parent().hide(); const filters = { startDate: $('#trucker-awarded-filter-start-date').val(), endDate: $('#trucker-awarded-filter-end-date').val() }; const result = await apiCall('/trucker/awarded-contracts', 'GET', filters); dataCache['trucker-awarded-table'] = result.data; if (result.data.length === 0) { tbody.parent().parent().show(); return renderEmptyState(empty, 'No contracts awarded yet.', 'fa-trophy');} tbody.html(result.data.map(c => `<tr><td>${c.load_id}</td><td>${c.loading_point_address}</td><td>${c.unloading_point_address}</td><td>${c.item_name || 'N/A'}</td><td>${c.truck_name || 'N/A'}</td><td>${c.approx_weight_tonnes ? c.approx_weight_tonnes + 'T' : 'N/A'}</td><td>${c.requirement_date ? formatDate(c.requirement_date) : 'N/A'}</td><td><strong>${formatCurrency(c.awarded_amount)}</strong></td><td>${formatDate(c.awarded_date)}</td></tr>`).join('')); tbody.parent().parent().show(); empty.empty(); } catch (e) {} }
        async function load_admin_dashboard_view() { try { const result = await apiCall('/admin/dashboard-stats'); const data = result.data; $('#stats-active-loads').text(data.activeLoads || '0'); $('#stats-pending-users').text(data.pendingUsers || '0'); $('#stats-pending-loads').text(data.pendingLoads || '0'); $('#stats-awarded-contracts').text(data.awardedContracts || '0'); createChart('adminLoadChart', 'bar', { labels: data.charts.loadTrends.labels, datasets: [{ label: 'Loads Created', data: data.charts.loadTrends.data, backgroundColor: '#5E72E4' }] }); createChart('adminTruckerBiddingChart', 'doughnut', { labels: data.charts.biddingActivity.labels, datasets: [{ data: data.charts.biddingActivity.data, backgroundColor: ['#5E72E4', '#2DCE89', '#FB6340', '#11CDEF', '#F5365C'] }] }); } catch (e) {} }
        
        async function load_admin_bulk_upload_history_view() {
            const tbody = $('#admin-bulk-history-tbody'), empty = $('#admin-bulk-history-empty-state');
            try {
                renderEmptyState(empty, 'Loading history...', 'fa-spinner fa-spin');
                tbody.parent().parent().hide();
                const result = await apiCall('/admin/bulk-upload-history');

                if (result.data.length === 0) {
                    tbody.parent().parent().show();
                    return renderEmptyState(empty, 'No bulk uploads have been performed yet.', 'fa-upload');
                }
                
                const statusColors = {
                    'SUCCESS': { text: 'success', icon: 'fa-check-circle' },
                    'PARTIAL': { text: 'warning', icon: 'fa-exclamation-triangle' },
                    'FAILED': { text: 'danger', icon: 'fa-times-circle' },
                    'PROCESSING': { text: 'info', icon: 'fa-spinner fa-spin' }
                };

                tbody.html(result.data.map(h => {
                    const statusInfo = statusColors[h.status] || { text: 'secondary', icon: 'fa-question-circle' };
                    const downloadButton = h.error_file_path 
                        ? `<button onclick="handleDownloadErrorFile(${h.upload_id}, '${h.file_name}')" class="btn btn-sm btn-outline-danger" title="Download Error Report"><i class="fas fa-file-excel"></i></button>` 
                        : '-';

                    return `<tr>
                        <td><small>${h.file_name}</small></td>
                        <td>${formatDate(h.started_at, true)}</td>
                        <td>${h.completed_at ? formatDate(h.completed_at, true) : '-'}</td>
                        <td>${h.uploaded_by_name}</td>
                        <td>
                            <span class="badge text-bg-${statusInfo.text}"><i class="fas ${statusInfo.icon} me-1"></i> ${h.status}</span>
                        </td>
                        <td>${h.total_rows}</td>
                        <td class="text-success fw-bold">${h.success_count}</td>
                        <td class="text-danger fw-bold">${h.error_count}</td>
                        <td>${downloadButton}</td>
                    </tr>`
                }).join(''));

                tbody.parent().parent().show();
                empty.empty();
            } catch (e) {
                tbody.parent().parent().show();
                renderEmptyState(empty, 'Failed to load upload history.', 'fa-exclamation-triangle');
            }
        }
        
        async function load_admin_pending_loads_view() { 
            const tbody = $('#admin-pending-loads-tbody'), empty = $('#admin-pending-loads-empty-state'); 
            try { 
                renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); 
                tbody.parent().parent().hide(); 
                const result = await apiCall('/admin/all-loads', 'GET', { status: 'Pending Approval' }); 
                if (result.data.length === 0) { 
                    tbody.parent().parent().show(); 
                    return renderEmptyState(empty, 'No loads are pending approval.', 'fa-inbox');
                } 
                tbody.html(result.data.map(l => `
                    <tr data-load-id="${l.load_id}">
                        <td><input type="checkbox" class="form-check-input load-checkbox"></td>
                        <td>${l.inhouse_requisition_no || '-'}</td>
                        <td>${l.load_id}</td>
                        <td>${l.loading_point_address}</td>
                        <td>${l.unloading_point_address}</td>
                        <td>${l.item_name}</td>
                        <td>${l.truck_name}</td>
                        <td>${l.approx_weight_tonnes}T</td>
                        <td>${formatDate(l.requirement_date)}</td>
                        <td>${l.remarks || '-'}</td>
                    </tr>`).join('')); 
                tbody.parent().parent().show(); 
                empty.empty(); 
            } catch (e) {
                tbody.parent().parent().show();
                renderEmptyState(empty, 'Failed to load data.', 'fa-exclamation-triangle');
            } 
        }

        async function handleBulkApproval(reqId) { const c = $(`#collapse-${reqId}`), loads = c.find('.load-check-box:checked').map((i, el) => $(el).val()).get(), truckers = c.find('.trucker-assign-check:checked').map((i, el) => $(el).val()).get(), biddingStartTime = c.find('.bidding-start-time-input').val(), biddingDurationMinutes = c.find('.bidding-duration-input').val(); if (loads.length === 0) return showToast('Select at least one load.', 'error'); if (truckers.length === 0) return showToast('Assign at least one trucker.', 'error'); if (!biddingStartTime) return showToast('Bidding Start Time is mandatory.', 'error'); try { await apiCall('/loads/approve', 'POST', { approvedLoadIds: loads, truckerAssignments: truckers, requisitionId: reqId, biddingStartTime, biddingDurationMinutes }); showToast('Loads processed!', 'success'); load_admin_pending_loads_view(); } catch (e) {} }
        
        async function load_admin_all_loads_view() { const tbody = $('#admin-loads-tbody'), empty = $('#admin-loads-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().parent().hide(); const filters = { status: $('#admin-loads-filter-status').val(), startDate: $('#admin-loads-filter-start-date').val(), endDate: $('#admin-loads-filter-end-date').val() }; const result = await apiCall('/admin/all-loads', 'GET', filters); dataCache['admin-loads-table'] = result.data; if (result.data.length === 0) { tbody.parent().parent().show(); return renderEmptyState(empty, 'No loads found for the selected filters.');} tbody.html(result.data.map(l => `<tr data-load-id="${l.load_id}" data-load-times='${JSON.stringify({start: l.bidding_start_time, end: l.bidding_end_time})}'><td><input type="checkbox" class="form-check-input load-checkbox"></td><td>${l.inhouse_requisition_no || '-'}</td><td>${l.load_id}</td><td>${l.loading_point_address}</td><td>${l.unloading_point_address}</td><td>${l.item_name}</td><td>${l.truck_name}</td><td>${l.approx_weight_tonnes}T</td><td>${formatDate(l.requirement_date)}</td><td><span class="badge bg-${getBadgeColor(l.status)}">${l.status}</span></td><td>${l.l1_bid ? formatCurrency(l.l1_bid) : '-'}</td><td>${l.remarks || '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-info" title="View Bids" onclick="openViewBidsModal(${l.load_id})"><i class="fas fa-gavel"></i></button><button class="btn btn-secondary" title="Assign Truckers" onclick="openAssignTruckersModal(${l.requisition_id})"><i class="fas fa-users"></i></button><button class="btn btn-warning" title="Set Time" onclick="openSetBiddingTimeModal(${l.load_id})"><i class="fas fa-clock"></i></button></div></td></tr>`).join('')); tbody.parent().parent().show(); empty.empty(); } catch (e) {} }
        
        async function load_admin_manage_loads_view() { const tbody = $('#admin-manage-loads-tbody'), empty = $('#admin-manage-loads-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().parent().hide(); const result = await apiCall('/admin/all-loads', 'GET', {}); if (result.data.length === 0) { tbody.parent().parent().show(); return renderEmptyState(empty, 'No loads found.');} tbody.html(result.data.map(l => `<tr><td>${l.inhouse_requisition_no || '-'}</td><td>${l.load_id}</td><td>${l.loading_point_address}</td><td>${l.unloading_point_address}</td><td>${l.item_name}</td><td>${l.truck_name}</td><td>${l.approx_weight_tonnes}T</td><td>${formatDate(l.requirement_date)}</td><td><span class="badge bg-${getBadgeColor(l.status)}">${l.status}</span></td><td>${l.remarks || '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-primary" title="Edit Load" onclick="openEditLoadModal(${l.load_id})"><i class="fas fa-edit"></i></button><button class="btn btn-danger" title="Delete Load" onclick="handleDeleteLoad(${l.load_id})"><i class="fas fa-trash"></i></button></div></td></tr>`).join('')); tbody.parent().parent().show(); empty.empty(); } catch (e) {} }
        
        async function load_admin_bidding_history_view() { const tbody = $('#admin-bids-tbody'), empty = $('#admin-bids-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().parent().hide(); const filters = { startDate: $('#admin-bids-filter-start-date').val(), endDate: $('#admin-bids-filter-end-date').val() }; const result = await apiCall('/admin/bidding-history', 'GET', filters); dataCache['admin-bids-table'] = result.data; if (result.data.length === 0) { tbody.parent().parent().show(); return renderEmptyState(empty, 'No bidding history found.'); } tbody.html(result.data.map(b => `<tr><td>${b.inhouse_requisition_no || '-'}</td><td>${b.load_id}</td><td>${b.loading_point_address}</td><td>${b.unloading_point_address}</td><td>${b.item_name}</td><td>${b.truck_name}</td><td>${formatDate(b.requirement_date)}</td><td>${b.trucker_name}</td><td>${b.company_name || '-'}</td><td><strong>${formatCurrency(b.bid_amount)}</strong></td><td>${b.remarks || '-'}</td><td>${formatDate(b.submitted_at, true)}</td></tr>`).join('')); tbody.parent().parent().show(); empty.empty(); } catch (e) {} }

        async function load_admin_awarded_contracts_view() { 
            const tbody = $('#admin-awarded-tbody'), empty = $('#admin-awarded-empty-state'); 
            try { 
                renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); 
                tbody.parent().parent().hide(); 
                const filters = { startDate: $('#admin-awarded-filter-start-date').val(), endDate: $('#admin-awarded-filter-end-date').val() }; 
                const result = await apiCall('/admin/awarded-contracts', 'GET', filters); 
                dataCache['admin-awarded-table'] = result.data;
                if (result.data.length === 0) { 
                    tbody.parent().parent().show(); 
                    return renderEmptyState(empty, 'No contracts awarded yet.', 'fa-trophy'); 
                } 
                tbody.html(result.data.map(c => {
                    const contractData = JSON.stringify(c);
                    return `<tr>
                        <td><input type="checkbox" class="form-check-input awarded-load-checkbox" data-load-id="${c.load_id}"></td>
                        <td>${c.inhouse_requisition_no || '-'}</td>
                        <td>${c.load_id}</td>
                        <td>${c.trucker_name}</td>
                        <td><small>${c.trucker_email || 'N/A'}<br>${c.trucker_contact || 'N/A'}</small></td>
                        <td><small>${c.loading_point_address}</small></td>
                        <td><small>${c.unloading_point_address}</small></td>
                        <td>${c.item_name || 'N/A'}</td>
                        <td>${c.truck_name || 'N/A'}</td>
                        <td>${c.requirement_date ? formatDate(c.requirement_date) : 'N/A'}</td>
                        <td><strong>${formatCurrency(c.awarded_amount)}</strong></td>
                        <td>${formatDate(c.awarded_date)}</td>
                        <td><button class="btn btn-sm btn-info send-email-btn" data-contract='${contractData}' title="Send Email"><i class="fas fa-envelope"></i></button></td>
                    </tr>`;
                }).join('')); 
                tbody.parent().parent().show(); 
                empty.empty(); 
            } catch (e) {} 
        }

        async function load_admin_reports_view() { const kpiContainer = $('#report-kpis'), tableBody = $('#detailed-report-table tbody'); try { kpiContainer.html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin')); tableBody.empty(); const result = await apiCall('/admin/reports-data', 'POST', { startDate: $('#report-start-date').val(), endDate: $('#report-end-date').val() }); const { kpis, detailedReport, chartsData } = result.data; dataCache['detailed-report-table'] = detailedReport; const awardedLoadsCount = kpis.awardedLoads || 0; kpiContainer.html(`<div class="col-md-6"><div class="card card-body"><h6>Total Spend</h6><h3 class="fw-bold">${formatCurrency(kpis.totalSpend)}</h3></div></div><div class="col-md-6"><div class="card card-body"><h6>Total Loads Awarded</h6><h3 class="fw-bold">${awardedLoadsCount}</h3></div></div>`); if (detailedReport.length === 0) { tableBody.html(`<tr><td colspan="12" class="text-center text-muted">No data for this period.</td></tr>`); } else { tableBody.html(detailedReport.map(r => `<tr><td>${r.inhouse_requisition_no || '-'}</td><td>${r.load_id}</td><td>${r.loading_point_address}</td><td>${r.unloading_point_address}</td><td>${r.item_name}</td><td>${r.truck_name}</td><td>${r.approx_weight_tonnes}T</td><td>${formatDate(r.requirement_date)}</td><td>${r.trucker_name}</td><td>${formatCurrency(r.awarded_amount)}</td><td>${r.remarks || '-'}</td><td>${formatDate(r.awarded_date)}</td></tr>`).join('')); } if(chartsData) { createChart('top-truckers-chart', 'pie', { labels: chartsData.topTruckers.labels, datasets: [{ data: chartsData.topTruckers.data, backgroundColor: ['#5E72E4', '#2DCE89', '#FB6340', '#11CDEF', '#F5365C'] }] }); createChart('spend-material-chart', 'bar', { labels: chartsData.spendByMaterial.labels, datasets: [{ label: 'Spend', data: chartsData.spendByMaterial.data, backgroundColor: '#FB6340' }] }); createChart('spend-time-chart', 'line', { labels: chartsData.spendOverTime.labels, datasets: [{ label: 'Total Spend', data: chartsData.spendOverTime.data, borderColor: '#5E72E4', tension: 0.1 }] }); } } catch (e) {} }
        
        async function openSetBiddingTimeModal(loadId) {
            const row = $(`tr[data-load-id="${loadId}"]`);
            const times = row.data('load-times');
            $('#setTimeLoadId').val(loadId);
            $('#setTimeLoadName').text(loadId);

            const formatForInput = (dateString) => dateString ? dateString.slice(0, 16).replace(' ', 'T') : '';
            $('#setTimeStartTime').val(formatForInput(times.start));

            if (times.start && times.end) {
                const startTime = new Date(times.start.replace(' ', 'T'));
                const endTime = new Date(times.end.replace(' ', 'T'));
                const durationMinutes = (endTime - startTime) / 60000;
                $('#setTimeDuration').val(durationMinutes);
            } else {
                $('#setTimeDuration').val('15');
            }

            setBiddingTimeModal.show();
        }

        async function handleSetBiddingTimeSubmit() {
            const loadId = $('#setTimeLoadId').val();
            const startTimeStr = $('#setTimeStartTime').val();
            const durationMinutes = parseInt($('#setTimeDuration').val(), 10);

            if (!startTimeStr) {
                return showToast('Please select a Bidding Start Time.', 'error');
            }

            const formattedStartTime = startTimeStr.replace('T', ' ') + ':00';
            const startTimeObj = new Date(startTimeStr);
            const endTimeObj = new Date(startTimeObj.getTime() + durationMinutes * 60000);

            const pad = (num) => num.toString().padStart(2, '0');
            const formattedEndTime = `${endTimeObj.getFullYear()}-${pad(endTimeObj.getMonth() + 1)}-${pad(endTimeObj.getDate())} ${pad(endTimeObj.getHours())}:${pad(endTimeObj.getMinutes())}:${pad(endTimeObj.getSeconds())}`;

            try {
                await apiCall('/admin/loads/bidding-time', 'PUT', {
                    loadId,
                    startTime: formattedStartTime,
                    endTime: formattedEndTime
                });
                showToast('Bidding time updated!', 'success');
                setBiddingTimeModal.hide();
                load_admin_all_loads_view();
            } catch (e) {}
        }

        function openBulkSetTimeModal() { 
            const selectedLoads = $('.load-checkbox:checked').map((i, el) => $(el).closest('tr').data('load-id')).get(); 
            if (selectedLoads.length === 0) { 
                return showToast('Please select at least one load to set time.', 'warning'); 
            } 
            $('#bulk-set-time-count').text(selectedLoads.length); 
            $('#bulkSetTimeStartTime').val(''); 
            bulkSetTimeModal.show(); 
        }

        async function handleBulkSetTimeSubmit() {
            const loadIds = $('.load-checkbox:checked').map((i, el) => $(el).closest('tr').data('load-id')).get();
            const startTimeStr = $('#bulkSetTimeStartTime').val();
            const durationMinutes = parseInt($('#bulkSetTimeDuration').val(), 10);

            if (loadIds.length === 0) {
                return showToast('Please select at least one load.', 'warning');
            }
            if (!startTimeStr) {
                return showToast('Please select a Bidding Start Time.', 'error');
            }

            const formattedStartTime = startTimeStr.replace('T', ' ') + ':00';
            const startTimeObj = new Date(startTimeStr);
            const endTimeObj = new Date(startTimeObj.getTime() + durationMinutes * 60000);
            
            const pad = (num) => num.toString().padStart(2, '0');
            const formattedEndTime = `${endTimeObj.getFullYear()}-${pad(endTimeObj.getMonth() + 1)}-${pad(endTimeObj.getDate())} ${pad(endTimeObj.getHours())}:${pad(endTimeObj.getMinutes())}:${pad(endTimeObj.getSeconds())}`;

            try {
                const result = await apiCall('/admin/loads/bulk-bidding-time', 'PUT', {
                    loadIds,
                    startTime: formattedStartTime,
                    endTime: formattedEndTime
                });
                showToast(result.message, 'success');
                bulkSetTimeModal.hide();
                load_admin_all_loads_view();
            } catch (e) {}
        }
        
        async function handleDownloadErrorFile(uploadId, originalFileName) {
            showLoader();
            try {
                const token = sessionStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/admin/download-error-file/${uploadId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error('Unauthorized. Please log in again.');
                    const errText = await response.text();
                    throw new Error(errText || 'File not found or server error.');
                }

                const blob = await response.blob();
                const contentDisposition = response.headers.get('content-disposition');
                let filename = `error_${originalFileName || 'report'}.xlsx`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch && filenameMatch.length > 1) {
                        filename = filenameMatch[1];
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        function showToast(m, t = 'info') { const c = $('#toast-container'), e = $(`<div><i class="fas ${t === 'success' ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i><span>${m}</span></div>`).addClass(`toast-notification ${t}`); c.append(e); setTimeout(() => e.remove(), 4000); }
        function showLoader() { $('#loader-overlay').removeClass('hidden'); }
        function hideLoader() { $('#loader-overlay').addClass('hidden'); }
        function renderEmptyState(container, message, iconClass = 'fa-folder-open') { const html = `<div class="text-center p-5 text-muted"><i class="fas ${iconClass} fa-3x mb-3"></i><p>${message}</p></div>`; if (container) $(container).html(html); return html; }
        function formatCurrency(v) { const n = parseFloat(v); return isNaN(n) ? '0' : `${n.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`; }
        function formatDate(d, includeTime = false) { if (!d) return 'N/A'; const date = new Date(d.replace(' ', 'T') + 'Z'); const options = { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'Asia/Kolkata' }; if (includeTime) { options.hour = 'numeric'; options.minute = '2-digit'; options.hour12 = true; } return new Intl.DateTimeFormat('en-IN', options).format(date); }
        function formatMessageTime(d) { if (!d) return ''; const date = new Date(d.replace(' ', 'T') + 'Z'); return date.toLocaleTimeString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata' }); }
        function getBadgeColor(s) { return { 'Awarded': 'primary', 'Active': 'success', 'Pending Approval': 'warning', 'Submitted': 'info', 'Rejected': 'danger', 'Processed': 'secondary', 'Admin': 'info', 'Super Admin': 'danger', 'Trucker': 'success', 'Shipper': 'secondary' }[s] || 'dark'; }
        function createChart(chartId, type, data, options = {}) { if (charts[chartId]) charts[chartId].destroy(); const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return; charts[chartId] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options } }); }
        async function fetchSidebarCounts() { try { const result = await apiCall('/sidebar-counts', 'GET', null, false, false); if (result.success) { $('#badge-unread-messages').text(result.data.unreadMessages > 0 ? result.data.unreadMessages : '').toggle(result.data.unreadMessages > 0); $('#badge-pending-loads').text(result.data.pendingLoads > 0 ? result.data.pendingLoads : '').toggle(result.data.pendingLoads > 0); $('#badge-pending-users').text(result.data.pendingUsers > 0 ? result.data.pendingUsers : '').toggle(result.data.pendingUsers > 0); if(result.data.unreadMessages > 0) { $('#notification-bell-badge').removeClass('visually-hidden'); } else { $('#notification-bell-badge').addClass('visually-hidden'); } } } catch (e) {} }
        
        function generateAwardMailBody(c) { const body = `Dear ${c.trucker_name},\n\nCongratulations! You have been awarded the following contract. Please find the details below:\n\n----------------------------------------\nIn-house Req No.:  ${c.inhouse_requisition_no || 'N/A'}\nLoading Point:   ${c.loading_point_address}\nUnloading Point:  ${c.unloading_point_address}\nMaterial:      ${c.item_name || 'N/A'}\nTruck Type:     ${c.truck_name || 'N/A'}\nWeight:       ${c.approx_weight_tonnes ? c.approx_weight_tonnes + 'T' : 'N/A'}\nRequirement Date:  ${c.requirement_date ? formatDate(c.requirement_date) : 'N/A'}\nYour Awarded Bid:  ${formatCurrency(c.awarded_amount)}\nRemarks:      ${c.remarks || 'N/A'}\n----------------------------------------\n\nOur team will contact you shortly regarding the next steps.\n\nSincerely,\nThe Laser Power Truck Bidding Team`; return body; }
        function sendAwardConfirmation(contract) { if (!contract.trucker_email) { return showToast('This trucker does not have an email address.', 'error'); } const subject = `Contract Award Confirmation - Load ID: ${contract.load_id}`; const body = generateAwardMailBody(contract); const mailtoLink = `mailto:${contract.trucker_email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; window.location.href = mailtoLink; }

        async function openViewBidsModal(loadId) { $('#viewBidsModalTitle').text(`Bids for Load #${loadId}`); $('#viewBidsModalBody').html(renderEmptyState(null, 'Loading bids...', 'fa-spinner fa-spin')); viewBidsModal.show(); try { const result = await apiCall(`/admin/loads/${loadId}/bids`); if (!result.data || !result.data.bids) { throw new Error("Invalid data received for bids."); } if (result.data.bids.length === 0) { $('#viewBidsModalBody').html('<p class="text-center">No bids have been submitted for this load yet.</p>'); return; } const bidsHTML = `<table class="table table-sm"><thead><tr><th>Select</th><th>Rank</th><th>Trucker</th><th>Bid Amount</th><th>Negotiation Rate</th><th>Date</th></tr></thead><tbody>` + result.data.bids.map((b, i) => { const bidData = { ...b, ...result.data.loadDetails }; return `<tr><td><input class="form-check-input" type="radio" name="award-radio-${loadId}" value='${JSON.stringify(bidData)}'></td><td><span class="badge bg-info">L${i + 1}</span></td><td>${b.trucker_name}</td><td><strong>${formatCurrency(b.bid_amount)}</strong></td><td><input type="number" class="form-control form-control-sm negotiation-rate" placeholder="Final Rate"></td><td>${formatDate(b.submitted_at, true)}</td></tr>` }).join('') + `</tbody></table><div class="mt-3"><label>Remarks</label><textarea class="form-control" id="award-remarks-${loadId}"></textarea><button class="btn btn-success mt-2 float-end" onclick="handleSingleAward(${loadId})">Award Selected</button></div>`; $('#viewBidsModalBody').html(bidsHTML); } catch (e) { $('#viewBidsModalBody').html(renderEmptyState(null, 'Could not load bids. Please try again.', 'fa-exclamation-triangle')); } }
        
        async function handleSingleAward(loadId) {
            const remarks = $(`#award-remarks-${loadId}`).val();
            if (!remarks) return showToast('Remarks are mandatory.', 'warning');
            
            const selectedRadio = $(`input[name="award-radio-${loadId}"]:checked`);
            if (selectedRadio.length === 0) return showToast('Please select a bid to award.', 'warning');

            const bidData = JSON.parse(selectedRadio.val());
            const negotiationRate = selectedRadio.closest('tr').find('.negotiation-rate').val();
            
            bidData.final_amount = negotiationRate && parseFloat(negotiationRate) > 0 ? parseFloat(negotiationRate) : bidData.bid_amount;
            bidData.remarks = remarks;

            try {
                await apiCall('/contracts/award', 'POST', { bids: [bidData] });
                showToast('Load awarded!', 'success');
                viewBidsModal.hide();
                handleManualRefresh();
            } catch (e) {}
        }
        
        async function openAssignTruckersModal(requisitionId) { $('#assign-trucker-req-id').val(requisitionId); const checklistDiv = $('#assign-trucker-checklist').html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin')); assignTruckersModal.show(); try { const result = await apiCall('/users/truckers', 'GET', null, false, false); const allTruckers = result.data; const truckersHtml = allTruckers.map(t => `<div class="form-check"><input class="form-check-input assign-trucker-checkbox" type="checkbox" value="${t.user_id}" checked><label class="form-check-label">${t.full_name}</label></div>`).join(''); checklistDiv.html(truckersHtml || '<p class="text-muted">No active truckers found.</p>'); } catch (e) { checklistDiv.html('<p class="text-danger">Could not load trucker list.</p>');} }
        async function handleUpdateTruckerAssignments() { const requisitionId = $('#assign-trucker-req-id').val(); const truckerIds = $('#assign-trucker-checklist input:checked').map((i, el) => $(el).val()).get(); try { await apiCall(`/requisitions/${requisitionId}/assignments`, 'PUT', { truckerIds }); showToast('Assignments updated!', 'success'); assignTruckersModal.hide(); if ($('#admin-loads-tbody').length) load_admin_all_loads_view(); } catch (e) {} }
        async function load_admin_user_approvals_view() { const tbody = $('#admin-pending-users-tbody'), empty = $('#admin-pending-users-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/users/pending'); if (result.data.length === 0) return renderEmptyState(empty, 'No users are pending approval.', 'fa-user-check'); empty.empty(); tbody.html(result.data.map(u => `<tr><td>${u.full_name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.company_name || '-'}</td><td>${u.contact_number || '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-success" onclick="approveUser(${u.temp_id})">Approve</button> <button class="btn btn-danger" onclick="rejectUser(${u.temp_id})">Reject</button></div></td></tr>`).join('')); } catch (e) {} }
        async function approveUser(id) { if (confirm('Approve user?')) { try { await apiCall('/users/approve', 'POST', { temp_id: id }); showToast('User Approved!', 'success'); load_admin_user_approvals_view(); } catch (e) {} } }
        async function rejectUser(id) { if (confirm('Reject user?')) { try { await apiCall(`/pending-users/${id}`, 'DELETE'); showToast('User Rejected.', 'success'); load_admin_user_approvals_view(); } catch (e) {} } }
        async function load_admin_user_control_view() { const tbody = $('#admin-users-tbody'), empty = $('#admin-users-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/users'); if (result.data.length === 0) return renderEmptyState(empty, 'No users found.', 'fa-users'); empty.empty(); tbody.html(result.data.map(u => `<tr><td>${u.full_name}</td><td>${u.email}</td><td><span class="badge bg-${getBadgeColor(u.role)}">${u.role}</span></td><td>${u.company_name || '-'}</td><td>${u.contact_number || '-'}</td><td>${u.gstin || '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-primary" onclick='openEditUserModal(${JSON.stringify(u)})'>Edit</button><button class="btn btn-danger" onclick="handleDeleteUser(${u.user_id})">Delete</button></div></td></tr>`).join('')); } catch (e) {} }
        function openAddUserModal() { $('#add-user-form')[0].reset(); addUserModal.show(); }
        async function handleAddUserSubmit(e) { e.preventDefault(); const data = { full_name: $('#add-fullname').val(), email: $('#add-email').val(), password: $('#add-password').val(), role: $('#add-role').val(), company_name: $('#add-company').val(), contact_number: $('#add-contact').val(), gstin: $('#add-gstin').val() }; try { await apiCall('/users', 'POST', data); showToast('User created!', 'success'); addUserModal.hide(); $('#add-user-form')[0].reset(); load_admin_user_control_view(); } catch (e) {} }
        function openEditUserModal(u) { $('#edit-userid').val(u.user_id); $('#edit-fullname').val(u.full_name); $('#edit-email').val(u.email); $('#edit-role').val(u.role); $('#edit-company').val(u.company_name || ''); $('#edit-contact').val(u.contact_number || ''); $('#edit-gstin').val(u.gstin || ''); $('#edit-password').val(''); editUserModal.show(); }
        async function handleUserUpdateSubmit(e) { e.preventDefault(); const id = $('#edit-userid').val(), data = { full_name: $('#edit-fullname').val(), email: $('#edit-email').val(), role: $('#edit-role').val(), company_name: $('#edit-company').val(), contact_number: $('#edit-contact').val(), gstin: $('#edit-gstin').val(), password: $('#edit-password').val() }; try { await apiCall(`/users/${id}`, 'PUT', data); showToast('User updated!', 'success'); editUserModal.hide(); load_admin_user_control_view(); } catch (e) {} }
        async function handleDeleteLoad(loadId) { if (confirm(`Are you sure you want to delete Load ID #${loadId}? This will also delete all associated bids.`)) { try { await apiCall(`/loads/${loadId}`, 'DELETE'); showToast('Load deleted successfully!', 'success'); load_admin_manage_loads_view(); } catch (error) {} } }
        async function openEditLoadModal(loadId) { try { showLoader(); const [loadRes, itemsRes, trucksRes] = await Promise.all([ apiCall(`/loads/${loadId}`, 'GET', null, false, false), apiCall('/master-data/items', 'GET', null, false, false), apiCall('/master-data/truck-types', 'GET', null, false, false) ]); hideLoader(); const load = loadRes.data; const itemOptions = itemsRes.data.map(i => `<option value="${i.item_id}">${i.item_name}</option>`).join(''); const truckOptions = trucksRes.data.map(t => `<option value="${t.truck_type_id}">${t.truck_name}</option>`).join(''); $('#edit-material').html(itemOptions); $('#edit-truck-type').html(truckOptions); $('#edit-load-id').val(load.load_id); $('#edit-loading-point').val(load.loading_point_address); $('#edit-unloading-point').val(load.unloading_point_address); $('#edit-material').val(load.item_id); $('#edit-truck-type').val(load.truck_type_id); $('#edit-weight').val(load.approx_weight_tonnes); const reqDate = new Date(load.requirement_date); const formattedDate = reqDate.toISOString().split('T')[0]; $('#edit-req-date').val(formattedDate); editLoadModal.show(); } catch (error) { hideLoader(); showToast('Failed to load data for editing.', 'error'); } }
        async function load_admin_master_data_view() { try { const [items, trucks] = await Promise.all([apiCall('/master-data/items'), apiCall('/master-data/truck-types')]); $('#item-master-tbody').html(items.data.map(i => `<tr><td>${i.item_name}</td><td><span class="badge bg-${i.is_active ? 'success' : 'danger'}">${i.is_active ? 'Active' : 'Inactive'}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick='openMasterDataModal("item", ${JSON.stringify(i)})'><i class="fas fa-edit"></i></button></td></tr>`).join('')); $('#truck-master-tbody').html(trucks.data.map(t => `<tr><td>${t.truck_name}</td><td><span class="badge bg-${t.is_active ? 'success' : 'danger'}">${t.is_active ? 'Active' : 'Inactive'}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick='openMasterDataModal("truck", ${JSON.stringify(t)})'><i class="fas fa-edit"></i></button></td></tr>`).join('')); } catch (e) {} }
        function openMasterDataModal(type, data = null) { const isEdit = data !== null; $('#master-data-modal-title').text(`${isEdit ? 'Edit' : 'Add'} ${type === 'item' ? 'Material' : 'Truck Type'}`); const form = $('#master-data-form'); form.data('type', type); form.data('id', isEdit ? (data.item_id || data.truck_type_id) : ''); $('#master-name').val(isEdit ? (data.item_name || data.truck_name) : ''); if (isEdit) { $('#master-active-switch').show(); $('#master-active').prop('checked', data.is_active); } else { $('#master-active-switch').hide(); } masterDataModal.show(); }
        async function handleMasterDataSubmit(e) { e.preventDefault(); const form = $(e.currentTarget); const type = form.data('type'), id = form.data('id'), isEdit = id !== ''; const name = $('#master-name').val(), isActive = $('#master-active').is(':checked'); const endpoint = isEdit ? `/master-data/${type}s/${id}` : `/master-data/${type}s`; const method = isEdit ? 'PUT' : 'POST'; const body = isEdit ? { name: name, is_active: isActive } : { name: name }; try { await apiCall(endpoint, method, body); showToast(`${type} data saved!`, 'success'); masterDataModal.hide(); load_admin_master_data_view(); } catch (e) {} }
        function openBulkUploadModal(type) { $('#bulk-upload-modal-title').text(`Bulk Upload ${type === 'item' ? 'Materials' : (type === 'truck' ? 'Truck Types' : 'Loads')}`); $('#download-template-link').off('click').on('click', () => downloadBulkTemplate(type)); $('#bulk-upload-type').val(type); bulkUploadModal.show(); }
        
        async function handleBulkUpload(e) {
            e.preventDefault();
            const file = $('#bulk-upload-file')[0].files[0];
            if (!file) return showToast('Please select a file.', 'error');
            const type = $('#bulk-upload-type').val();
            
            const endpoint = type === 'load' ? '/loads/bulk-upload' : `/master-data/${type}s/bulk-upload`;
            
            const formData = new FormData();
            formData.append('bulkFile', file);
            
            try {
                const result = await apiCall(endpoint, 'POST', formData, true);
                showToast(result.message, type === 'load' ? 'info' : 'success'); 
                bulkUploadModal.hide();
                
                if (type === 'load') {
                    navigateTo('admin-bulk-upload-history-view');
                } else {
                    load_admin_master_data_view();
                }
            } catch (e) {}
        }

        function downloadBulkTemplate(type) { let data, filename; if (type === 'load') { data = [{ "LoadingPoint": "City A", "UnloadingPoint": "City B", "MaterialName": "STEEL ITEMS", "TruckName": "10 Wheeler Truck", "WeightInTonnes": 15, "RequirementDate": "2025-10-25", "InhouseRequisitionNo": "REQ-123", "Remarks": "Urgent delivery" }]; filename = "Bulk_Load_Template.xlsx"; } else { data = [{ "Name": `Sample ${type === 'item' ? 'Material' : 'Truck'}` }]; filename = `Bulk_${type}_Template.xlsx`; } const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, filename); }
        
        function downloadTableData(tableId, filename) {
            const dataToDownload = dataCache[tableId];
            if (!dataToDownload || dataToDownload.length === 0) {
                showToast('No data available to download for the current filters.', 'info');
                return;
            }
            try {
                const ws = XLSX.utils.json_to_sheet(dataToDownload);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, filename);
                showToast('Downloading report...', 'success');
            } catch (error) {
                console.error("Download Error:", error);
                showToast('Could not generate Excel file.', 'error');
            }
        }
        
        function downloadReport() {
            downloadTableData('detailed-report-table', 'Awarded_Loads_Report.xlsx');
        }

        async function load_messaging_view() { const chatList = $('#chat-list'); try { renderEmptyState(chatList, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/conversations'); if (result.data.length === 0) return renderEmptyState(chatList, 'No users to chat with.'); chatList.html(result.data.map(u => `<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="openChat(${u.user_id}, '${u.full_name}')"><div class="chat-list-item"><strong class="chat-user-name">${u.full_name}</strong><div class="last-message">${u.last_message || `Role: ${u.role}`}</div></div><div class="text-end"><span class="badge bg-success rounded-pill">${u.unread_count > 0 ? u.unread_count : ''}</span><div class="message-info">${u.last_message_timestamp ? formatDate(u.last_message_timestamp, true) : ''}</div></div></a>`).join('')); } catch (e) {} }
        
        async function openChat(id, name) { 
            if (chatPollingInterval) clearInterval(chatPollingInterval); 
            $('#chat-welcome').addClass('d-none'); 
            $('#chat-window').removeClass('d-none'); 
            $('#chat-with-name').text(name); 
            $('#message-form').off('submit').on('submit', (e) => { e.preventDefault(); handleSendMessage(id); }); 
            const fetchAndRender = async () => { 
                const messagesDiv = $('#chat-messages'); 
                const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); 
                // FIX: Set showLoaderFlag to false for silent refresh
                const result = await apiCall(`/messages/${id}`, 'GET', null, false, false); 
                if (!result.success) return; 
                const isScrolledToBottom = messagesDiv.scrollTop() + messagesDiv.innerHeight() >= messagesDiv[0].scrollHeight - 50; 
                messagesDiv.html(''); 
                
                result.data.forEach(msg => {
                    const isSent = msg.sender_id == currentUser.user_id;
                    const wrapperClass = isSent ? 'sent' : 'received';
                    const bubbleClass = isSent ? 'sent-bubble' : 'received-bubble';
                    const ticksHtml = isSent ? `<span class="message-ticks ${msg.status === 'read' ? 'read' : ''}"></span>` : '';

                    const messageHtml = `
                    <div class="message-wrapper ${wrapperClass}">
                        <div class="message-bubble ${bubbleClass}">
                            <div class="message-text">${msg.message_body.replace(/\n/g, '<br>')}</div>
                            <div class="message-meta">
                                <span class="timestamp">${formatMessageTime(msg.timestamp)}</span> 
                                ${ticksHtml}
                            </div>
                        </div>
                    </div>`;
                    messagesDiv.append(messageHtml);
                });

                if (isScrolledToBottom || messagesDiv.html() === '') { messagesDiv.scrollTop(messagesDiv[0].scrollHeight); } 
            }; 
            await fetchAndRender(); 
            chatPollingInterval = setInterval(fetchAndRender, 7000); 
        }

        async function handleSendMessage(id) { const input = $('#message-input'); if (!input.val()) return; try { await apiCall('/messages', 'POST', { recipientId: id, messageBody: input.val() }, false, false); input.val(''); openChat(id, $('#chat-with-name').text()); } catch (e) {} }
        async function openAdvancedBulkAwardModal() { const loadIds = $('.load-checkbox:checked').map((i, el) => $(el).closest('tr').data('load-id')).get(); if (loadIds.length === 0) return showToast('Please select loads to award.', 'warning'); try { const result = await apiCall('/admin/bids-for-loads', 'POST', { loadIds }); if (!result.success) return; const accordionContainer = $('#advanced-bulk-award-modal-body').html(''); result.data.forEach((loadData, index) => { let bidsTableHtml = '<p class="text-center text-muted">No bids submitted.</p>'; if (loadData.bids && loadData.bids.length > 0) { bidsTableHtml = `<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>Select</th><th>Rank</th><th>Trucker</th><th>Amount ()</th><th>Negotiation Rate</th></tr></thead><tbody>${loadData.bids.map((bid, rankIndex) => { const bidDataForAward = { ...bid, ...loadData, trucker_name: bid.trucker_name, trucker_email: bid.trucker_email }; return `<tr><td><input class="form-check-input" type="radio" name="award-radio-${loadData.load_id}" value='${JSON.stringify(bidDataForAward)}'></td><td><span class="badge bg-info">L${rankIndex + 1}</span></td><td>${bid.trucker_name}</td><td><strong>${formatCurrency(bid.bid_amount)}</strong></td><td><input type="number" class="form-control form-control-sm negotiation-rate" placeholder="Final Rate"></td></tr>`; }).join('')}</tbody></table></div>`; } accordionContainer.append(`<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-award-${loadData.load_id}"><strong>Load #${loadData.load_id}:</strong> ${loadData.loading_point_address} to ${loadData.unloading_point_address}</button></h2><div id="collapse-award-${loadData.load_id}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#advanced-bulk-award-modal-body"><div class="accordion-body">${bidsTableHtml}</div></div></div>`); }); $('#advanced-bulk-award-remarks').val(''); advancedBulkAwardModal.show(); } catch (e) { advancedBulkAwardModal.hide(); showToast('Failed to load data for bulk award. Please try again.', 'error'); } }
        async function handleSubmitAdvancedBulkAward() { const remarks = $('#advanced-bulk-award-remarks').val().trim(); if (!remarks) return showToast('Remarks are mandatory.', 'error'); const winningBids = $('#advanced-bulk-award-modal-body input[type="radio"]:checked').map((i, radio) => { const bidData = JSON.parse(radio.value); const negotiationRate = $(radio).closest('tr').find('.negotiation-rate').val(); bidData.final_amount = negotiationRate && parseFloat(negotiationRate) > 0 ? parseFloat(negotiationRate) : bidData.bid_amount; bidData.remarks = remarks; return bidData; }).get(); if (winningBids.length === 0) return showToast('Please select at least one bid to award.', 'warning'); try { await apiCall('/contracts/award', 'POST', { bids: winningBids }); showToast('Loads awarded successfully!', 'success'); advancedBulkAwardModal.hide(); handleManualRefresh(); } catch (e) {} }
        function openReopenBiddingModal() { const loadIdsToReopen = $('.awarded-load-checkbox:checked').map((i, el) => $(el).data('load-id')).get(); if (loadIdsToReopen.length === 0) return showToast('Please select at least one awarded load to re-open.', 'info'); $('#reopen-load-ids').val(JSON.stringify(loadIdsToReopen)); $('#reopen-remarks').val(''); const checklistDiv = $('#reopen-trucker-checklist').html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin')); reopenBiddingModal.show(); apiCall('/users/truckers', 'GET', null, false, false).then(result => { if (result.success && result.data) { const truckersHtml = result.data.map(t => `<div class="form-check"><input class="form-check-input reopen-trucker-checkbox" type="checkbox" value="${t.user_id}" id="reopen-t-${t.user_id}" checked><label class="form-check-label" for="reopen-t-${t.user_id}">${t.full_name}</label></div>`).join(''); checklistDiv.html(truckersHtml || '<p class="text-muted">No truckers found.</p>'); } else { checklistDiv.html('<p class="text-danger">Could not load trucker list.</p>'); } }); }
        async function submitReopenBidding() { const loadIds = JSON.parse($('#reopen-load-ids').val()); const remarks = $('#reopen-remarks').val().trim(); const truckerIds = $('#reopen-trucker-checklist .reopen-trucker-checkbox:checked').map((i, el) => $(el).val()).get(); if (!remarks) return showToast('Remarks are mandatory.', 'error'); if (truckerIds.length === 0) return showToast('Please select at least one trucker.', 'error'); try { await apiCall('/loads/reopen-bidding', 'POST', { loadIds, remarks, truckerIds }); showToast('Bidding re-opened successfully!', 'success'); reopenBiddingModal.hide(); handleManualRefresh(); } catch (e) {} }
        
        async function openBulkApproveModal() {
            const selectedLoads = $('#admin-pending-loads-table .load-checkbox:checked').map(function() {
                return $(this).closest('tr').data('load-id');
            }).get();

            if (selectedLoads.length === 0) {
                return showToast('Please select at least one load to approve.', 'warning');
            }
            $('#bulk-approve-count').text(selectedLoads.length);
            const checklistDiv = $('#bulk-approve-trucker-checklist').html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin'));
            bulkApproveModal.show();

            try {
                const result = await apiCall('/users/truckers', 'GET', null, false, false);
                if (result.success && result.data) {
                    const truckersHtml = result.data.map(t => `
                        <div class="form-check">
                            <input class="form-check-input bulk-approve-trucker-checkbox" type="checkbox" value="${t.user_id}" id="bulk-approve-t-${t.user_id}" checked>
                            <label class="form-check-label" for="bulk-approve-t-${t.user_id}">${t.full_name}</label>
                        </div>`).join('');
                    checklistDiv.html(truckersHtml || '<p class="text-muted">No truckers found.</p>');
                } else {
                    checklistDiv.html('<p class="text-danger">Could not load trucker list.</p>');
                }
            } catch (e) {
                checklistDiv.html('<p class="text-danger">Could not load trucker list.</p>');
            }
        }

        async function handleBulkApproveSubmit() {
            const loadIds = $('#admin-pending-loads-table .load-checkbox:checked').map(function() {
                return $(this).closest('tr').data('load-id');
            }).get();
            
            const truckerIds = $('#bulk-approve-trucker-checklist .bulk-approve-trucker-checkbox:checked').map((i, el) => $(el).val()).get();
            const biddingStartTime = $('#bulkApproveStartTime').val();
            const biddingDurationMinutes = $('#bulkApproveDuration').val();

            if (loadIds.length === 0) return showToast('No pending loads selected.', 'error');
            if (!biddingStartTime) return showToast('Bidding Start Time is mandatory.', 'error');
            if (truckerIds.length === 0) return showToast('Please select at least one trucker.', 'error');
            
            const data = { loadIds, truckerIds, biddingStartTime, biddingDurationMinutes };

            try {
                await apiCall('/loads/bulk-approve', 'POST', data);
                showToast(`${loadIds.length} loads have been approved and assigned.`, 'success');
                bulkApproveModal.hide();
                navigateTo('admin-pending-loads-view');
            } catch (e) {}
        }
    </script>
</body>
</html>
